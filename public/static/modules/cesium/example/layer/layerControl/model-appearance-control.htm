<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>模型缓存图层样式设置</title>
    <!--加载Cesium脚本库及其样式-->
    <script src="http://10.10.130.72:8086/static/libs/cdn/cesium/Cesium.js"></script>
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/cdn/cesium/Widgets/widgets.css"
    />
    <!--plugin脚本库-->
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-common.min.js"></script>
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-cesium-plugin.min.js"></script>
    <script src="http://10.10.130.72:8086/static/assets/js/TDT-token.js"></script>
    <!--示例公共样式-->
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/css/style.css"
    />
  </head>

  <body>
    <div id="mapgis-3d-viewer"></div>
    <div id="app-tips">
      提示：PBR光照功能依赖模型材质和法向量，需要模型自身支持才能生效
    </div>
    <script type="module">
      'use strict'
      import { Pane } from 'http://10.10.130.72:8086/static/libs/cdn/tweakpane/tweakpane.min.js'

      // 定义创建图层与UI交互相关的变量
      let map, sceneView, viewer, pane, layer

      // 该方法用于初始化三维地图查看器，包括创建图层管理容器，初始化地图视图对象以及获取Cesium场景视图对象
      function initViewer() {
        map = new zondy.Map()
        sceneView = new zondy.cesium.SceneView({
          viewId: 'mapgis-3d-viewer',
          map: map
        })
        viewer = sceneView.getInnerView()
      }

      /**
       * 该方法用于添加模型缓存图层，根据模型缓存类型创建对应的模型缓存图层对象
       * @param {string} url - 模型缓存文件的URL地址
       * @param {string} modelType - 模型缓存类型，可选值为'M3D'或'3DTILES'
       */
      function addModelCacheLayer(url, modelType) {
        const lastLayer = layer
        let modelCacheLayer = undefined

        if (modelType === 'M3D') {
          modelCacheLayer = new zondy.layer.M3DModelCacheLayer({
            url,
            extensionOptions: {
              // 视角自动跳转
              autoReset: true
            }
          })
        } else if (modelType === '3DTILES') {
          modelCacheLayer = new zondy.layer.Cesium3DTilesCacheLayer({
            url,
            extensionOptions: {
              // 视角自动跳转
              autoReset: true
            }
          })
        }

        if (modelCacheLayer) {
          map.add(modelCacheLayer)
          // 图层加载完毕的回调方法
          modelCacheLayer.on('layerview-created', function (result) {
            // 获取内部图层对象，即MapGISM3DSet或Cesium3DTileset对象
            layer = sceneView.getInnerLayer(result.layer)
            // 在添加模型缓存图层后，要移除之前的模型缓存图层
            if (viewer.scene.primitives.contains(lastLayer)) {
              viewer.scene.primitives.remove(lastLayer)
            }
          })
        }
      }

      // 该方法用于初始化UI操作面板
      function initUI() {
        pane = new Pane({
          title: '操作面板'
        })
        const modelCacheBladeFolder = pane.addFolder({
          title: '模型缓存类型'
        })
        const modelStylingFolder = pane.addFolder({
          title: '模型样式控制'
        })
        const modelLightingFolder = pane.addFolder({
          title: '模型光照控制'
        })

        // 定义默认参数
        const paneParameters = {
          brightness: 0, // 亮度
          exposure: 0, // 曝光度
          contrast: 1, // 对比度
          hue: 0, // 色相
          saturation: 0, // 饱和度
          gamma: 1, // 伽马
          enablePbrLighting: true // PBR光照
        }

        // 该控件允许用户在MapGIS M3D和Cesium 3D Tiles两种模型类型之间切换
        const modelTypeList = modelCacheBladeFolder
          .addBlade({
            view: 'list',
            label: '切换类型',
            options: [
              {
                text: 'MapGIS M3D',
                value: 'M3D'
              },
              {
                text: 'Cesium 3D Tiles',
                value: '3DTILES'
              }
            ],
            value: 'M3D'
          })
          .on('change', (e) => {
            // 根据选择的模型类型切换显示对应的模型列表并加载模型数据
            if (e.value === 'M3D') {
              cesium3DTilesModelList.hidden = true
              M3DModelList.hidden = false
              addModelCacheLayer(
                'http://10.10.130.72:8200/3DData/ModelCache/M3D/1.0/景观示例/景观_建筑模型_1.mcj',
                'M3D'
              )
            } else if (e.value === '3DTILES') {
              cesium3DTilesModelList.hidden = false
              M3DModelList.hidden = true
              addModelCacheLayer(
                'http://10.10.130.72:8200/3DData/ModelCache/3DTileset/1.0/dayantaresult/tileset.json',
                '3DTILES'
              )
            }
            resetPaneParameters()
          })

        // 定义MapGIS M3D的模型缓存列表
        const M3DModelList = modelCacheBladeFolder
          .addBlade({
            view: 'list',
            label: 'M3D',
            options: [
              {
                text: '景观示例-M3D 1.0-文件服务',
                value:
                  'http://10.10.130.72:8200/3DData/ModelCache/M3D/1.0/景观示例/景观_建筑模型_1.mcj'
              },
              {
                text: '中地大楼倾斜摄影-M3D 2.0-M3dServer',
                value:
                  'http://10.10.130.72:8089/igs/rest/services/M3Dv2/zondyOSGB/M3dServer'
              }
            ],
            value:
              'http://10.10.130.72:8200/3DData/ModelCache/M3D/1.0/景观示例/景观_建筑模型_1.mcj'
          })
          .on('change', (e) => {
            addModelCacheLayer(e.value, 'M3D')
            resetPaneParameters()
          })

        // 定义Cesium 3D Tiles的模型缓存列表
        const cesium3DTilesModelList = modelCacheBladeFolder
          .addBlade({
            hidden: true,
            view: 'list',
            label: '3D Tiles',
            options: [
              {
                text: '大雁塔倾斜摄影-3D Tiles 1.0-文件服务',
                value:
                  'http://10.10.130.72:8200/3DData/ModelCache/3DTileset/1.0/dayantaresult/tileset.json'
              },
              {
                text: '小别墅-3D Tiles 1.0-文件服务',
                value:
                  'http://10.10.130.72:8200/3DData/ModelCache/3DTileset/1.0/小别墅2018/tileset.json'
              }
            ],
            value:
              'http://10.10.130.72:8200/3DData/ModelCache/3DTileset/1.0/dayantaresult/tileset.json'
          })
          .on('change', (e) => {
            addModelCacheLayer(e.value, '3DTILES')
            resetPaneParameters()
          })

        modelStylingFolder
          .addBinding(paneParameters, 'brightness', {
            label: '亮度',
            min: -1,
            max: 1
          })
          .on('change', (e) => {
            layer.brightness = e.value
          })

        modelStylingFolder
          .addBinding(paneParameters, 'exposure', {
            label: '曝光度',
            min: -1,
            max: 1
          })
          .on('change', (e) => {
            layer.exposure = e.value
          })

        modelStylingFolder
          .addBinding(paneParameters, 'contrast', {
            label: '对比度',
            min: 0,
            max: 2
          })
          .on('change', (e) => {
            layer.contrast = e.value
          })

        modelStylingFolder
          .addBinding(paneParameters, 'hue', {
            label: '色相',
            min: 0,
            max: 1
          })
          .on('change', (e) => {
            layer.hue = e.value
          })

        modelStylingFolder
          .addBinding(paneParameters, 'saturation', {
            label: '饱和度',
            min: -1,
            max: 1
          })
          .on('change', (e) => {
            layer.saturation = e.value
          })

        modelStylingFolder
          .addBinding(paneParameters, 'gamma', {
            label: '伽马',
            min: 0,
            max: 3
          })
          .on('change', (e) => {
            layer.gamma = e.value
          })

        modelLightingFolder
          .addBinding(paneParameters, 'enablePbrLighting', {
            label: 'PBR光照'
          })
          .on('change', (e) => {
            layer.enablePbrLighting = e.value
          })

        pane
          .addButton({
            title: '重置'
          })
          .on('click', () => {
            resetPaneParameters()
          })

        // 该方法用于重置默认参数并同步UI操作面板
        function resetPaneParameters() {
          paneParameters.brightness = 0
          paneParameters.exposure = 0
          paneParameters.contrast = 1
          paneParameters.hue = 0
          paneParameters.saturation = 0
          paneParameters.gamma = 1
          paneParameters.enablePbrLighting = true
          pane.refresh()
        }
      }

      // 该方法用于初始化整个应用，包括初始化查看器、添加模型缓存图层和初始化用户界面
      function init() {
        initViewer()
        addModelCacheLayer(
          'http://10.10.130.72:8200/3DData/ModelCache/M3D/1.0/景观示例/景观_建筑模型_1.mcj',
          'M3D'
        )
        initUI()
      }

      init()
    </script>

    <style>
      #mapgis-3d-viewer {
        position: absolute;
        left: 0;
        top: 0;
      }
      /* tweakpane样式 */
      .tp-dfwv {
        position: absolute;
        top: 10px;
        right: 10px;
      }
      /* 提示内容样式 */
      #app-tips {
        position: absolute;
        top: 10px;
        left: 10px;
        /* left: 50%; */
        /* transform: translateX(-50%); */
        background: #28292e;
        color: #f5f5f5;
        padding: 5px;
        user-select: none;
        font-size: 12px;
        border-radius: 2px;
      }
    </style>
  </body>
</html>
