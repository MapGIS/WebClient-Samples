<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>流体模拟</title>
    <!--加载Cesium库-->
    <script src="http://10.10.130.72:8086/static/libs/cdn/cesium/Cesium.js"></script>
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/cdn/cesium/Widgets/widgets.css"
    />
    <!--plugin脚本库-->
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-common.min.js"></script>
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-cesium-plugin.min.js"></script>
    <script src="http://10.10.130.72:8086/static/assets/js/TDT-token.js"></script>
    <!--示例公共样式-->
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/css/style.css"
    />
  </head>

  <body>
    <div id="mapgis-3d-viewer"></div>
    <script type="module">
      'use strict'
      import { Pane } from 'http://10.10.130.72:8086/static/libs/cdn/tweakpane/tweakpane.min.js'

      // 定义视图、流体模拟相关变量
      let map,
        sceneView,
        viewer,
        fluid,
        pane,
        singleColorTable,
        multipleColorTable,
        rigidEntity,
        rigidEntityTransparent

      // 地图初始化函数
      async function init() {
        // 初始化球体
        initViewer()
        // 添加地形
        await addTerrain()
        // 添加模型
        await addModel()
        // 添加天地图
        addTDT()
        // 初始化流体模拟对象
        initFluid()
        // 初始化示例UI组件
        initUI()
      }

      init()

      // 初始化球体
      function initViewer() {
        // 初始化图层管理容器
        map = new zondy.Map()
        // 初始化地图视图对象
        sceneView = new zondy.cesium.SceneView({
          // 视图id
          viewId: 'mapgis-3d-viewer',
          // 图层管理容器
          map: map,
          // 额外参数
          extensionOptions: {
            // 开启场景时间轴
            timeline: true
          }
        })
        // 获取视图对象
        viewer = sceneView.getInnerView()
        // 开启场景光照
        viewer.scene.globe.enableLighting = true
        // 开启地形深度测试
        viewer.scene.globe.depthTestAgainstTerrain = true
        // 设置初始视角
        viewer.camera.setView({
          destination: new Cesium.Cartesian3(
            -2271409.331480808,
            5014280.460999426,
            3225998.0381823024
          )
        })
      }

      // 添加地形
      async function addTerrain() {
        viewer.terrainProvider = await Cesium.CesiumTerrainProvider.fromUrl(
          'http://localhost/data/Terrain/武汉地形/'
        )
      }

      // 添加模型
      async function addModel() {
        const tileset = await Cesium.MapGISM3DSet.fromUrl(
          'http://10.10.130.72:8200/3DData/ModelCache/M3D/2.0/武汉建筑轮廓白/武汉建筑轮廓白.mcj'
        )
        viewer.scene.primitives.add(tileset)
      }

      // 添加天地图
      function addTDT() {
        let TDTLayer = new zondy.layer.WMTSLayer({
          // 加载经纬度的影像地图
          url: 'http://t6.tianditu.gov.cn/img_c/wmts',
          // 天地图必须加token，且token名为tk
          tokenKey: 'tk',
          // token请在天地图官网申请
          tokenValue: getTDTToken()
        })
        map.add(TDTLayer)
      }

      // 初始化流体模拟对象
      function initFluid() {
        // 定义流体模拟的色表：一种是所有高度一致的单一颜色，一种是不同高度区间渐变的多颜色
        singleColorTable = {
          0: new Cesium.Color(0.211, 0.243, 0.598, 0.9)
        }
        multipleColorTable = {
          0: new Cesium.Color(0, 0, 0.4, 1),
          5: new Cesium.Color(0, 1, 1, 1),
          10: new Cesium.Color(0, 1, 0, 1),
          15: new Cesium.Color(1, 1, 0, 1),
          20: new Cesium.Color(1, 0, 0, 1)
        }

        // 设置流体模拟的范围
        const rectangle = Cesium.Rectangle.fromDegrees(
          114.32978332427275,
          30.52283992091235,
          114.41004647393699,
          30.556329379876573
        )

        // 初始化流体模拟的对象
        fluid = new zondy.cesium.Fluid({
          viewer,
          rectangle,
          samplePrecision: 4, // 采样精度
          color: multipleColorTable
        })

        // 显示流体模拟盒子
        fluid.showBox()
      }

      // 初始化UI组件
      function initUI() {
        pane = new Pane({
          title: '流体模拟操作面板'
        })

        const tab = pane.addTab({
          pages: [{ title: '流体控制' }, { title: '特效调整' }]
        })

        const sceneControlFolder = tab.pages[0].addFolder({
          title: '场景控制'
        })

        const fluidFolder = tab.pages[0].addFolder({
          title: '流体基础'
        })

        const fluidColorTableFolder = tab.pages[0].addFolder({
          title: '流体色表'
        })

        const fluidSourceControlFolder = tab.pages[0].addFolder({
          title: '流体源控制'
        })

        const fluidRigidControlFolder = tab.pages[0].addFolder({
          title: '流体刚体控制'
        })

        const fluidShadowFolder = tab.pages[1].addFolder({
          title: '流体阴影'
        })

        const flowParticleFolder = tab.pages[1].addFolder({
          title: '流体粒子'
        })

        const fluidFoamFolder = tab.pages[1].addFolder({
          title: '白浪效果'
        })

        const fluidSpecularFolder = tab.pages[1].addFolder({
          title: '高光效果'
        })

        const fluidReflectionFolder = tab.pages[1].addFolder({
          title: '反射效果'
        })

        const controls = {
          // 场景控制
          debugShowFramesPerSecond: false,
          depthTestAgainstTerrain: true,
          // 流体基础
          showFluid: true,
          fluidSpeed: 240,
          debugShowBoxGeometry: true,
          // 流体粒子
          fadeOpacity: 0.05,
          flowParticleColor: { r: 255, g: 0, b: 0, a: 1 },
          flowParticleLineWidth: 4,
          showFlowParticle: true,
          flowParticleNumber: 10000 * 25,
          // 白浪效果
          showFluidFoam: false,
          fluidFoamSize: 0.7,
          fluidFoamDensity: 2,
          fluidFoamIntensity: 2,
          fluidFoamColor: { r: 255, g: 255, b: 255, a: 1 },
          // 高光效果
          showFluidSpecular: false,
          fluidSpecularBrightness: 0.8,
          fluidSpecularSize: 50,
          fluidSpecularLength: 35,
          // 阴影效果
          showFluidShadows: false,
          fluidShadowsDarkness: 0.3,
          fluidShadowsMaximumDistance: 5000,
          fluidShadowsSoftShadows: false,
          // 反射效果
          showFluidReflection: false,
          fluidReflectionOpacity: 0.5,
          fluidReflectionMaxDistance: 500,
          fluidReflectionThickness: 0,
          // 添加点流体源的参数
          addPointFluidSourceRadius: 200,
          addPointFluidSourceFlow: 300,
          // 添加全域流体源的参数
          addVolumeFluidSourceIntensity: 10
        }

        sceneControlFolder
          .addBinding(controls, 'debugShowFramesPerSecond', {
            label: '显示帧率'
          })
          .on('change', (e) => {
            viewer.scene.debugShowFramesPerSecond = e.value
          })

        sceneControlFolder
          .addBinding(controls, 'depthTestAgainstTerrain', {
            label: '深度测试'
          })
          .on('change', (e) => {
            viewer.scene.globe.depthTestAgainstTerrain = e.value
          })

        fluidFolder
          .addBinding(controls, 'debugShowBoxGeometry', {
            label: '显示盒子'
          })
          .on('change', (e) => {
            if (e.value) {
              fluid.showBox()
            } else {
              fluid.hideBox()
            }
          })

        fluidFolder
          .addBinding(controls, 'showFluid', {
            label: '显示流体'
          })
          .on('change', (e) => {
            fluid.show = e.value
          })

        fluidFolder
          .addBinding(controls, 'fluidSpeed', {
            label: '流动速度',
            min: 0,
            max: 500
          })
          .on('change', (e) => {
            fluid.speed = e.value
          })

        fluidFolder
          .addButton({
            title: '开始模拟'
          })
          .on('click', () => {
            fluid.start()
          })

        fluidFolder
          .addButton({
            title: '暂停模拟'
          })
          .on('click', () => {
            fluid.pause()
          })

        fluidFolder
          .addButton({
            title: '销毁流体模拟对象'
          })
          .on('click', () => {
            fluid.destroy()
          })

        fluidColorTableFolder
          .addBlade({
            view: 'list',
            label: '流体色表',
            options: [
              { text: '多色色表', value: 'MULTIPLE' },
              { text: '单色色表', value: 'SINGLE' }
            ],
            value: 'MULTIPLE'
          })
          .on('change', (e) => {
            if (e.value === 'SINGLE') {
              fluid.color = singleColorTable
            } else if (e.value === 'MULTIPLE') {
              fluid.color = multipleColorTable
            }
          })

        flowParticleFolder
          .addBinding(controls, 'showFlowParticle', {
            label: '显示粒子'
          })
          .on('change', (e) => {
            fluid.flowParticle.show = e.value
          })

        flowParticleFolder
          .addBinding(controls, 'fadeOpacity', {
            label: '消散速度',
            min: 0,
            max: 1
          })
          .on('change', (e) => {
            fluid.flowParticle.fadeOpacity = e.value
          })

        flowParticleFolder
          .addBinding(controls, 'flowParticleColor', {
            label: '粒子颜色'
          })
          .on('change', (e) => {
            fluid.flowParticle.color = Cesium.Color.fromBytes(
              e.value.r,
              e.value.g,
              e.value.b,
              e.value.a * 255
            )
          })

        flowParticleFolder
          .addBinding(controls, 'flowParticleLineWidth', {
            label: '粒子线宽',
            min: 1,
            max: 10
          })
          .on('change', (e) => {
            fluid.flowParticle.lineWidth = e.value
          })

        flowParticleFolder
          .addBinding(controls, 'flowParticleNumber', {
            label: '粒子数量',
            min: 10000,
            max: 500000
          })
          .on('change', (e) => {
            fluid.flowParticle.number = e.value
          })

        fluidFoamFolder
          .addBinding(controls, 'showFluidFoam', {
            label: '显示白浪'
          })
          .on('change', (e) => {
            fluid.foam.show = e.value
          })

        fluidFoamFolder
          .addBinding(controls, 'fluidFoamSize', {
            label: '白浪大小',
            min: 0,
            max: 5
          })
          .on('change', (e) => {
            fluid.foam.size = e.value
          })

        fluidFoamFolder
          .addBinding(controls, 'fluidFoamDensity', {
            label: '白浪密度',
            min: 0,
            max: 10
          })
          .on('change', (e) => {
            fluid.foam.density = e.value
          })

        fluidFoamFolder
          .addBinding(controls, 'fluidFoamIntensity', {
            label: '白浪强度',
            min: 0,
            max: 10
          })
          .on('change', (e) => {
            fluid.foam.intensity = e.value
          })

        fluidFoamFolder
          .addBinding(controls, 'fluidFoamColor', {
            label: '白浪颜色'
          })
          .on('change', (e) => {
            fluid.foam.color = Cesium.Color.fromBytes(
              e.value.r,
              e.value.g,
              e.value.b,
              e.value.a * 255
            )
          })

        fluidSpecularFolder
          .addBinding(controls, 'showFluidSpecular', {
            label: '显示高光'
          })
          .on('change', (e) => {
            fluid.specular.show = e.value
          })

        fluidSpecularFolder
          .addBinding(controls, 'fluidSpecularBrightness', {
            label: '高光强度',
            min: 0,
            max: 1
          })
          .on('change', (e) => {
            fluid.specular.brightness = e.value
          })

        fluidSpecularFolder
          .addBinding(controls, 'fluidSpecularSize', {
            label: '高光大小',
            min: 0,
            max: 100
          })
          .on('change', (e) => {
            fluid.specular.size = e.value
          })

        fluidSpecularFolder
          .addBinding(controls, 'fluidSpecularLength', {
            label: '高光长度',
            min: 0,
            max: 100
          })
          .on('change', (e) => {
            fluid.specular.length = e.value
          })

        fluidShadowFolder
          .addBinding(controls, 'showFluidShadows', {
            label: '显示阴影'
          })
          .on('change', (e) => {
            viewer.shadows = e.value
          })

        fluidShadowFolder
          .addBinding(controls, 'fluidShadowsDarkness', {
            label: '阴影明暗',
            min: 0,
            max: 1
          })
          .on('change', (e) => {
            fluid.shadow.darkness = e.value
          })

        fluidShadowFolder
          .addBinding(controls, 'fluidShadowsMaximumDistance', {
            label: '最大距离',
            min: 0,
            max: 10000
          })
          .on('change', (e) => {
            fluid.shadow.maximumDistance = e.value
          })

        fluidShadowFolder
          .addBinding(controls, 'fluidShadowsSoftShadows', {
            label: '柔和阴影'
          })
          .on('change', (e) => {
            fluid.shadow.softShadows = e.value
          })

        fluidReflectionFolder
          .addBinding(controls, 'showFluidReflection', {
            label: '显示反射'
          })
          .on('change', (e) => {
            fluid.reflection.show = e.value
          })

        fluidReflectionFolder
          .addBinding(controls, 'fluidReflectionOpacity', {
            label: '反射透明',
            min: 0,
            max: 1
          })
          .on('change', (e) => {
            fluid.reflection.opacity = e.value
          })

        fluidReflectionFolder
          .addBinding(controls, 'fluidReflectionMaxDistance', {
            label: '反射距离',
            min: 0,
            max: 1000
          })
          .on('change', (e) => {
            fluid.reflection.maxDistance = e.value
          })

        fluidReflectionFolder
          .addBinding(controls, 'fluidReflectionThickness', {
            label: '反射厚度',
            min: 0,
            max: 1
          })
          .on('change', (e) => {
            fluid.reflection.thickness = e.value
          })

        fluidRigidControlFolder
          .addButton({
            title: '添加刚体'
          })
          .on('click', () => {
            let positions = []
            document.body.style.cursor = 'crosshair'
            let handler = new Cesium.ScreenSpaceEventHandler(
              viewer.scene.canvas
            )

            handler.setInputAction(function (movement) {
              const ray = viewer.camera.getPickRay(movement.position)
              const cartesian = viewer.scene.globe.pick(ray, viewer.scene)
              const cartographic =
                viewer.scene.globe.ellipsoid.cartesianToCartographic(cartesian)
              positions.push(cartographic.longitude, cartographic.latitude, 0)
            }, Cesium.ScreenSpaceEventType.LEFT_CLICK)

            handler.setInputAction(function (movement) {
              const ray = viewer.camera.getPickRay(movement.position)
              const cartesian = viewer.scene.globe.pick(ray, viewer.scene)
              const cartographic =
                viewer.scene.globe.ellipsoid.cartesianToCartographic(cartesian)
              positions.push(cartographic.longitude, cartographic.latitude, 0)
              if (positions.length < 2) {
                positions = []
                return
              }
              rigidEntityTransparent = viewer.entities.add({
                name: 'Green box with beveled corners and outline',
                polylineVolume: {
                  // positions: Cesium.Cartesian3.fromDegreesArrayHeights(positions),
                  positions:
                    Cesium.Cartesian3.fromRadiansArrayHeights(positions),
                  shape: [
                    new Cesium.Cartesian2(-5, -100),
                    new Cesium.Cartesian2(5, -100),
                    new Cesium.Cartesian2(5, 100),
                    new Cesium.Cartesian2(-5, 100)
                  ],
                  cornerType: Cesium.CornerType.BEVELED,
                  material: Cesium.Color.WHITE.withAlpha(0.5)
                }
              })
              rigidEntity = new Cesium.Entity({
                name: 'Green box with beveled corners and outline',
                polylineVolume: {
                  // positions: Cesium.Cartesian3.fromDegreesArrayHeights(positions),
                  positions:
                    Cesium.Cartesian3.fromRadiansArrayHeights(positions),
                  shape: [
                    new Cesium.Cartesian2(-5, -100),
                    new Cesium.Cartesian2(5, -100),
                    new Cesium.Cartesian2(5, 100),
                    new Cesium.Cartesian2(-5, 100)
                  ],
                  cornerType: Cesium.CornerType.BEVELED,
                  material: Cesium.Color.WHITE.withAlpha(1)
                }
              })
              fluid.addObjects({
                objects: [rigidEntity],
                heightMapUpdateCallback: () => {
                  viewer.entities.add(rigidEntity)
                  viewer.entities.remove(rigidEntityTransparent)
                }
              })
              positions = []
              document.body.style.cursor = 'default'
              handler.destroy()
            }, Cesium.ScreenSpaceEventType.RIGHT_CLICK)
          })

        fluidRigidControlFolder
          .addButton({
            title: '移除刚体'
          })
          .on('click', () => {
            fluid.removeObjects({
              objects: [rigidEntity],
              heightMapUpdateCallback: () => {
                viewer.entities.remove(rigidEntity)
              }
            })
          })

        fluidSourceControlFolder
          .addBinding(controls, 'addPointFluidSourceRadius', {
            label: '半径大小',
            min: 0,
            max: 1000
          })
          .on('change', (e) => {
            controls.addPointFluidSourceRadius = e.value
          })

        fluidSourceControlFolder
          .addBinding(controls, 'addPointFluidSourceFlow', {
            label: '流量大小',
            min: 0,
            max: 1000
          })
          .on('change', (e) => {
            controls.addPointFluidSourceFlow = e.value
          })

        fluidSourceControlFolder
          .addButton({
            title: '添加点流体源'
          })
          .on('click', () => {
            document.body.style.cursor = 'crosshair'
            let handler = new Cesium.ScreenSpaceEventHandler(
              viewer.scene.canvas
            )
            handler.setInputAction((event) => {
              let ray = viewer.camera.getPickRay(event.position)
              let position = viewer.scene.globe.pick(ray, viewer.scene)
              fluid.fluidSources.add(
                new zondy.cesium.PointFluidSource({
                  position: position,
                  flow: controls.addPointFluidSourceFlow,
                  radius: controls.addPointFluidSourceRadius
                })
              )
              document.body.style.cursor = 'default'
              handler.destroy()
            }, Cesium.ScreenSpaceEventType.LEFT_CLICK)
          })

        fluidSourceControlFolder.addBlade({
          view: 'separator'
        })

        fluidSourceControlFolder
          .addBinding(controls, 'addVolumeFluidSourceIntensity', {
            label: '流量大小',
            min: 0,
            max: 100
          })
          .on('change', (e) => {
            controls.addVolumeFluidSourceIntensity = e.value
          })

        fluidSourceControlFolder
          .addButton({
            title: '添加全域流体源'
          })
          .on('click', () => {
            fluid.fluidSources.add(
              new zondy.cesium.VolumeFluidSource({
                intensity: 50
              })
            )
          })

        fluidSourceControlFolder.addBlade({
          view: 'separator'
        })

        fluidSourceControlFolder
          .addButton({
            title: '移除全部流体源'
          })
          .on('click', () => {
            fluid.fluidSources.removeAll()
          })
      }
    </script>

    <style>
      /* tweakpane样式 */
      .tp-dfwv {
        position: absolute;
        top: 10px;
        left: 10px;
      }
    </style>
  </body>
</html>
