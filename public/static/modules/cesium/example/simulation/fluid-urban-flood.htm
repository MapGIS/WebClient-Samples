<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>流体模拟 - 城市内涝</title>
    <!--加载Cesium库-->
    <script src="http://10.10.130.72:8086/static/libs/cdn/cesium/Cesium.js"></script>
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/cdn/cesium/Widgets/widgets.css"
    />
    <!--plugin脚本库-->
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-common.min.js"></script>
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-cesium-plugin.min.js"></script>
    <script src="http://10.10.130.72:8086/static/assets/js/TDT-token.js"></script>
    <!--示例公共样式-->
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/css/style.css"
    />
  </head>

  <body>
    <div id="mapgis-3d-viewer"></div>
    <div id="fluid-tips">
      提示：开启高光或阴影功能后，请拖动底部时间轴并观察
    </div>
    <script type="module">
      'use strict'
      import { Pane } from 'http://10.10.130.72:8086/static/libs/cdn/tweakpane/tweakpane.min.js'

      // 定义视图、流体模拟相关变量
      let map,
        sceneView,
        viewer,
        fluid,
        pane,
        singleColorTable,
        multipleColorTable1,
        multipleColorTable2,
        rigidEntityTransparent,
        rectangle,
        damEntity,
        debugBoxEntity,
        debugLineEntity

      // 地图初始化函数
      async function init() {
        // 初始化球体
        initViewer()
        // 添加地形
        await addTerrain()
        // 添加模型
        await addModel()
        // 添加天地图
        addTDT()
        // 初始化流体模拟对象
        initFluid()
        // 初始化示例UI组件
        initUI()
      }

      init()

      // 初始化球体
      function initViewer() {
        // 初始化图层管理容器
        map = new zondy.Map()
        // 初始化地图视图对象
        sceneView = new zondy.cesium.SceneView({
          // 视图id
          viewId: 'mapgis-3d-viewer',
          // 图层管理容器
          map: map,
          // 额外参数
          extensionOptions: {
            // 开启场景时间轴
            timeline: true
          }
        })
        // 获取视图对象
        viewer = sceneView.getInnerView()
        // 开启场景光照
        viewer.scene.globe.enableLighting = true
        // 开启地形深度测试
        viewer.scene.globe.depthTestAgainstTerrain = true

        // const iso8601 = '2025-06-23T01:00:00Z'
        const iso8601 = '2025-06-24T11:00:00Z'
        const currentTime = Cesium.JulianDate.fromIso8601(iso8601)
        const endTime = Cesium.JulianDate.addDays(
          currentTime,
          1,
          new Cesium.JulianDate()
        )
        viewer.clock.currentTime = currentTime
        viewer.timeline.zoomTo(currentTime, endTime)
      }

      // 添加地形
      async function addTerrain() {
        viewer.terrainProvider = await Cesium.CesiumTerrainProvider.fromUrl(
          'http://10.10.130.72:8200/3DData/TerrainCache/武汉地形'
        )
      }

      // 添加模型
      async function addModel() {
        const tileset = await Cesium.MapGISM3DSet.fromUrl(
          'http://10.10.130.72:8200/3DData/ModelCache/M3D/2.0/武汉建筑轮廓白/武汉建筑轮廓白.mcj'
        )
        const cartographic = Cesium.Cartographic.fromCartesian(
          tileset.boundingSphere.center
        )
        const translation = Cesium.Cartesian3.subtract(
          Cesium.Cartesian3.fromRadians(
            cartographic.longitude,
            cartographic.latitude,
            25
          ),
          Cesium.Cartesian3.fromRadians(
            cartographic.longitude,
            cartographic.latitude,
            0.0
          ),
          new Cesium.Cartesian3()
        )
        tileset.modelMatrix = Cesium.Matrix4.fromTranslation(translation)
        viewer.scene.primitives.add(tileset)
      }

      // 添加天地图
      function addTDT() {
        let TDTLayer = new zondy.layer.WMTSLayer({
          // 加载经纬度的影像地图
          url: 'http://t6.tianditu.gov.cn/img_c/wmts',
          // 天地图必须加token，且token名为tk
          tokenKey: 'tk',
          // token请在天地图官网申请
          tokenValue: getTDTToken()
        })
        map.add(TDTLayer)
      }

      // 初始化流体模拟对象
      function initFluid() {
        // 定义流体模拟的色表：一种是所有高度一致的单一颜色，一种是不同高度区间渐变的多颜色
        singleColorTable = {
          0: Cesium.Color.fromCssColorString('#0035BB')
        }
        multipleColorTable1 = {
          0: Cesium.Color.fromCssColorString('#EAF0FF'),
          3: Cesium.Color.fromCssColorString('#C9D8FE'),
          6: Cesium.Color.fromCssColorString('#A9C1FF'),
          9: Cesium.Color.fromCssColorString('#99B5FF'),
          12: Cesium.Color.fromCssColorString('#789EFF'),
          15: Cesium.Color.fromCssColorString('#477BFF'),
          18: Cesium.Color.fromCssColorString('#1E5EFF'),
          21: Cesium.Color.fromCssColorString('#0045F4'),
          24: Cesium.Color.fromCssColorString('#0035BB'),
          27: Cesium.Color.fromCssColorString('#002992'),
          30: Cesium.Color.fromCssColorString('#001B61'),
          33: Cesium.Color.fromCssColorString('#001449')
        }
        multipleColorTable2 = {
          0: Cesium.Color.fromCssColorString('#AAF189'),
          3: Cesium.Color.fromCssColorString('#A7F097'),
          6: Cesium.Color.fromCssColorString('#66B5FF'),
          9: Cesium.Color.fromCssColorString('#0003F6'),
          12: Cesium.Color.fromCssColorString('#FC01FF'),
          15: Cesium.Color.fromCssColorString('#84003B'),
          18: Cesium.Color.fromCssColorString('#FDAA05'),
          21: Cesium.Color.fromCssColorString('#D08A05'),
          24: Cesium.Color.fromCssColorString('#FC6607'),
          27: Cesium.Color.fromCssColorString('#FD6700'),
          30: Cesium.Color.fromCssColorString('#E40200'),
          33: Cesium.Color.fromCssColorString('#9E0005')
        }

        // 设置流体模拟的范围
        rectangle = Cesium.Rectangle.fromDegrees(114.29, 30.51, 114.35, 30.556)
        // 初始化流体模拟的对象
        fluid = new zondy.cesium.Fluid({
          viewer,
          rectangle,
          color: multipleColorTable1
        })

        // 创建点流体源对象
        const pointFluidSource1 = new zondy.cesium.PointFluidSource({
          position: new Cesium.Cartesian3(
            -2264434.1680969372,
            5010831.020850457,
            3221006.230337005
          ),
          radius: 200,
          flow: 300
        })
        fluid.fluidSources.add(pointFluidSource1)
        const pointFluidSource2 = new zondy.cesium.PointFluidSource({
          position: new Cesium.Cartesian3(
            -2262661.028399675,
            5011374.661382694,
            3221416.7627134533
          ),
          radius: 200,
          flow: 300
        })
        fluid.fluidSources.add(pointFluidSource2)

        fluid.readyPromise.then((fluid) => {
          // 重新设置一些特效参数
          fluid.flowParticle.show = true
          fluid.flowParticle.lineWidth = 4
          fluid.flowParticle.number = 200000
          fluid.foam.show = true
          fluid.foam.intensity = 5
          fluid.reflection.show = true
        })

        viewer.camera.flyTo({
          destination: {
            x: -2264561.8572952473,
            y: 5013322.543154248,
            z: 3222712.873754528
          },

          orientation: {
            heading: 6.283185307179583,
            pitch: -1.57079628737013,
            roll: 0
          },
          duration: 0
        })
      }

      // 初始化UI组件
      function initUI() {
        pane = new Pane({
          title: '流体模拟操作面板'
        })

        const sceneControlFolder = pane.addFolder({
          title: '场景控制'
          // expanded: false
        })

        const fluidFolder = pane.addFolder({
          title: '流体控制'
          // expanded: false
        })

        const fluidEffectFolder = pane.addFolder({
          title: '流体特效'
          // expanded: false
        })

        const cameraControlFolder = pane.addFolder({
          title: '视角控制'
        })

        const controls = {
          debugShowFramesPerSecond: false,
          showFluid: true,
          showDebugBoxEntity: false,
          showFlowParticle: true,
          showFluidSpecular: false,
          showFluidReflection: true,
          showFluidShadow: false,
          showFluidFoam: true,
          fluidSpeed: 317
        }

        sceneControlFolder
          .addBinding(controls, 'debugShowFramesPerSecond', {
            label: '显示帧率'
          })
          .on('change', (e) => {
            viewer.scene.debugShowFramesPerSecond = e.value
          })

        sceneControlFolder
          .addBinding(controls, 'showDebugBoxEntity', {
            label: '显示盒子'
          })
          .on('change', (e) => {
            if (e.value) {
              debugBoxEntity = viewer.entities.add({
                rectangle: {
                  coordinates: rectangle,
                  heightReference: Cesium.HeightReference.CLAMP_TO_TERRAIN,
                  extrudedHeight: 1000,
                  outline: true,
                  fill: true,
                  outlineColor: Cesium.Color.WHITE.withAlpha(0.9),
                  material: Cesium.Color.WHITE.withAlpha(0.2)
                }
              })
              debugLineEntity = viewer.entities.add({
                polyline: {
                  positions: Cesium.Cartesian3.fromRadiansArray([
                    rectangle.west,
                    rectangle.north,
                    rectangle.east,
                    rectangle.north,
                    rectangle.east,
                    rectangle.south,
                    rectangle.west,
                    rectangle.south,
                    rectangle.west,
                    rectangle.north
                  ]),
                  width: 1,
                  material: Cesium.Color.white,
                  clampToGround: true
                }
              })
            } else {
              viewer.entities.remove(debugBoxEntity)
              viewer.entities.remove(debugLineEntity)
            }
          })

        fluidFolder
          .addBinding(controls, 'showFluid', {
            label: '显示流体'
          })
          .on('change', (e) => {
            fluid.show = e.value
          })

        fluidFolder
          .addBinding(controls, 'fluidSpeed', {
            label: '流动速度',
            min: 0,
            max: 600
          })
          .on('change', (e) => {
            fluid.speed = e.value
          })

        const startButton = fluidFolder
          .addButton({
            title: '开始模拟',
            disabled: true
          })
          .on('click', () => {
            fluid.start()
            startButton.disabled = true
            pauseButton.disabled = false
          })

        const pauseButton = fluidFolder
          .addButton({
            title: '暂停模拟'
          })
          .on('click', () => {
            fluid.pause()
            startButton.disabled = false
            pauseButton.disabled = true
          })

        fluidFolder
          .addButton({
            title: '重置模拟'
          })
          .on('click', () => {
            fluid.destroy()
            initFluid()
          })

        fluidFolder
          .addBlade({
            view: 'list',
            label: '流体色表',
            options: [
              { text: '多色色表1', value: 'MULTIPLE1' },
              { text: '多色色表2', value: 'MULTIPLE2' },
              { text: '单色色表', value: 'SINGLE' }
            ],
            value: 'MULTIPLE1'
          })
          .on('change', (e) => {
            if (e.value === 'SINGLE') {
              fluid.color = singleColorTable
            } else if (e.value === 'MULTIPLE1') {
              fluid.color = multipleColorTable1
            } else if (e.value === 'MULTIPLE2') {
              fluid.color = multipleColorTable2
            }
          })

        fluidEffectFolder
          .addBinding(controls, 'showFlowParticle', {
            label: '显示粒子'
          })
          .on('change', (e) => {
            fluid.flowParticle.show = e.value
          })

        fluidEffectFolder
          .addBinding(controls, 'showFluidSpecular', {
            label: '显示高光'
          })
          .on('change', (e) => {
            fluid.specular.show = e.value
          })

        fluidEffectFolder
          .addBinding(controls, 'showFluidReflection', {
            label: '显示反射'
          })
          .on('change', (e) => {
            fluid.reflection.show = e.value
          })

        fluidEffectFolder
          .addBinding(controls, 'showFluidShadow', {
            label: '显示阴影'
          })
          .on('change', (e) => {
            viewer.shadows = e.value
          })

        fluidEffectFolder
          .addBinding(controls, 'showFluidFoam', {
            label: '显示白浪'
          })
          .on('change', (e) => {
            fluid.foam.show = e.value
          })

        cameraControlFolder
          .addButton({
            title: '全局位置'
          })
          .on('click', () => {
            viewer.camera.flyTo({
              destination: rectangle
            })
          })
        cameraControlFolder
          .addButton({
            title: '观察位置1'
          })
          .on('click', () => {
            viewer.camera.flyTo({
              destination: {
                x: -2263929.9007312604,
                y: 5012089.912440023,
                z: 3220276.926252974
              },

              orientation: {
                heading: 0.6009682004166397,
                pitch: -0.4428856040397662,
                roll: 0.000012209678028618498
              }
            })
            console.info('viewer.camera.position', viewer.camera.position)
            console.info('viewer.camera.orientation', {
              heading: viewer.camera.heading,
              pitch: viewer.camera.pitch,
              roll: viewer.camera.roll
            })
          })
        cameraControlFolder
          .addButton({
            title: '观察位置2'
          })
          .on('click', () => {
            viewer.camera.flyTo({
              destination: {
                x: -2264781.1163732423,
                y: 5011088.141823714,
                z: 3221207.3555455175
              },

              orientation: {
                heading: 4.465955131677486,
                pitch: -0.43565544186154614,
                roll: 6.283178084427997
              }
            })
          })
        cameraControlFolder
          .addButton({
            title: '观察位置3'
          })
          .on('click', () => {
            viewer.camera.flyTo({
              destination: {
                x: -2265042.6374235083,
                y: 5010809.961972139,
                z: 3221154.6514551593
              },

              orientation: {
                heading: 5.268442554621668,
                pitch: -0.030734930319843867,
                roll: 6.283172718900088
              }
            })
          })
      }
    </script>

    <style>
      /* tweakpane样式 */
      .tp-dfwv {
        position: absolute;
        top: 15px;
        /* left: 10px; */
        width: 240px;
      }

      /* 提示内容样式 */
      #fluid-tips {
        position: absolute;
        top: 15px;
        left: 15px;
        /* left: 50%; */
        /* transform: translateX(-50%); */
        background: #37383d;
        color: #f5f5f5;
        padding: 5px 7px;
        user-select: none;
        font-size: 12px;
        border-radius: 2px;
      }

      /* 调整帧率控件的位置 */
      .cesium-performanceDisplay-defaultContainer {
        left: 10px;
        right: auto;
      }
    </style>
  </body>
</html>
