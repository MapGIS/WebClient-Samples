<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>可视域分析</title>
    <!--加载不同版本Cesium库-->
    <script src="http://webclient.smaryun.com/static/libs/loadCesium.js"></script>
    <!--plugin脚本库-->
    <script src="http://webclient.smaryun.com/static/libs/cdn/zondyclient/webclient-common.min.js"></script>
    <script src="http://webclient.smaryun.com/static/libs/cdn/zondyclient/webclient-cesium-plugin.min.js"></script>
    <script src="http://webclient.smaryun.com/static/assets/js/TDT-token.js"></script>
    <!--示例公共样式-->
    <link
      rel="stylesheet"
      href="http://webclient.smaryun.com/static/libs/css/style.css"
    />
    <script type="module">
      'use strict'
      import { Pane } from 'http://webclient.smaryun.com/static/libs/cdn/tweakpane/tweakpane.min.js'

      // 定义三维视图的主要类
      let map, sceneView, viewer
      // 定义可视域分析
      let viewshed3d = null
      let viewshed3dAction = false
      let viewshed3ding = false
      let viewshedId = 0
      let viewshedVisibleRate = 0
      // 屏幕空间事件处理器
      let handler = null
      // 当前分析类型
      let currentType = 'MODEL'
      let pane = null

      // 初始化三维球体
      function initViewer() {
        // 初始化图层管理容器
        map = new zondy.Map()
        // 初始化地图视图对象
        sceneView = new zondy.cesium.SceneView({
          // 视图id
          viewId: 'mapgis-3d-viewer',
          // 图层管理容器
          map: map
        })
        // 获取视图对象
        viewer = sceneView.getInnerView()
        viewer.scene.globe.depthTestAgainstTerrain = true
        // computeViewshedVisibleRate()
      }

      // 添加一个可视域分析(鼠标点选)
      function addViewShed() {
        // 参考API: http://webclient.smaryun.com/static/modules/cesium/api/cesium/ViewshedAnalysis.html
        viewshed3d = new Cesium.ViewshedAnalysis()
        viewshed3dAction = true
        viewshed3ding = false
      }

      // 计算可视域分析可视率，在每次相机移动结束后计算
      function computeViewshedVisibleRate(controls) {
        viewer.scene.camera.moveEnd.addEventListener(() => {
          if (viewshed3d) {
            viewshedVisibleRate =
              viewer.scene.visualAnalysisManager.getViewshedVisibleRate()
            controls.viewshedVisibleRate = viewshedVisibleRate * 100
          }
        })
      }

      // 增加Cesium的ScreenSpaceEventHandler中的左键、移动、右键三个鼠标事件。
      function addCesiumScreenSpaceEventHandler() {
        handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas)
        handler.setInputAction(function (movement) {
          if (viewshed3d !== undefined) {
            if (viewshed3dAction) {
              viewer.scene.visualAnalysisManager.add(viewshed3d, viewshedId)
              let cartesian = viewer.scene.pickPosition(movement.position)
              let cartographic = Cesium.Cartographic.fromCartesian(cartesian)
              cartographic.height += 2.0
              cartesian = Cesium.Cartographic.toCartesian(cartographic)
              if (cartesian) {
                if (!viewshed3ding) {
                  viewshed3d.viewPosition = cartesian
                } else {
                  viewshed3d.targetPosition = cartesian
                  viewshed3dAction = false
                }
                viewshed3ding = true
              }
            }
          }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK)
        handler.setInputAction(function (movement) {
          if (viewshed3ding) {
            let cartesian = viewer.scene.pickPosition(movement.position)
            if (cartesian) {
              viewshed3d.targetPosition = cartesian
            }
            viewshed3dAction = false
            viewshed3ding = false
            viewshedId++
          }
        }, Cesium.ScreenSpaceEventType.RIGHT_CLICK)
        handler.setInputAction(function (movement) {
          if (viewshed3ding) {
            let cartesian = viewer.scene.pickPosition(movement.endPosition)
            if (cartesian) {
              viewshed3d.targetPosition = cartesian
            }
          }
        }, Cesium.ScreenSpaceEventType.MOUSE_MOVE)
      }

      // 通过既有参数，展示一个可视域分析结果
      // 可视域关注点是两个：观察点与目标点
      // 目标点可以直接是一个点，例如鼠标方式
      // 也可以通过其他参数(可视距离，方位角，俯仰角)，交由可视域分析接口来计算完成
      function addViewShedByOption() {
        // 由于可视域分析接口目前只支持一个展示，因此先删除已有的
        removeViewShed()
        // 观察点Cartesian3
        let viewPointLon, viewPointLat, viewPointHeight
        switch (currentType) {
          case 'MODEL':
            viewPointLon = 108.95919735136667
            viewPointLat = 34.21930564263558
            viewPointHeight = 18
            break
          case 'TERRAIN':
            viewPointLon = 120.5548
            viewPointLat = 23.3302
            viewPointHeight = 652
            break
        }
        // 观察点Cartesian3
        let viewPosition = Cesium.Cartesian3.fromDegrees(
          viewPointLon,
          viewPointLat,
          viewPointHeight
        )
        // 确定观察点的三个参数，即往什么方向，以什么俯仰角，看多远
        let viewRadius = 1000 // 半径米
        let heading = 30 // 方位角，以北顺时针
        let pitch = 15 // 俯仰角
        // 参考API: http://webclient.smaryun.com/static/modules/cesium/api/cesium/ViewshedAnalysis.html
        viewshed3d = new Cesium.ViewshedAnalysis()
        //将可视域分析添加到分析管理类中
        viewer.scene.visualAnalysisManager.add(viewshed3d)
        viewshed3d.viewPosition = viewPosition
        viewshed3d.viewRadius = viewRadius // 可视距离
        viewshed3d.heading = heading // 方位角
        viewshed3d.pitch = pitch // 俯仰角
        // 可视区域夹角，不可视颜色，可是颜色等其他参数(非必须)
        viewshed3d.horizontAngle = 45
        viewshed3d.verticalAngle = 45
        viewshed3d.visibleColor = Cesium.Color.BLUE
        viewshed3d.unVisibleColor = Cesium.Color.RED
      }

      // 移除可视域分析
      function removeViewShed() {
        viewer.scene.visualAnalysisManager.removeAll()
        viewshed3d = null
      }

      function addModel() {
        let M3DModelCacheLayer = new zondy.layer.M3DModelCacheLayer({
          // 服务基地址
          url: 'http://webclient.smaryun.com:8200/3DData/ModelCache/M3D/1.0/DaYanTa-M3D/dayanta.mcj'
        })
        map.add(M3DModelCacheLayer)
      }

      function addTerrain() {
        let igsSceneLayer = new zondy.layer.IGSSceneLayer({
          // 服务基地址
          url: 'http://webclient.smaryun.com:8089/igs/rest/services/Scene/TwTerrain/SceneServer',
          // 设置场景初始化参数
          scenes: [
            {
              // 设置子图层初始化参数
              sublayers: [
                {
                  // 子图层id
                  id: '0'
                }
              ]
            }
          ]
        })
        map.add(igsSceneLayer)
      }

      function addBillboard() {
        let graphicsLayer = new zondy.cesium.GraphicsLayer(viewer)
        let billboardGraphic = new zondy.cesium.Graphic({
          // 标绘类型
          type: 'billboard',
          // 标绘位置
          positions: [Cesium.Cartesian3.fromDegrees(108.9595, 34.2205, 0)],
          // 标绘样式
          style: {
            // 广告牌图片URL
            image: 'http://webclient.smaryun.com:8200/NoneSpatialData/image/icon.png',
            // 广告牌宽度
            width: 120,
            // 广告牌高度
            height: 120,
            // 离地高度
            offsetHeight: 10
          }
        })
        // 将标绘添加入标绘图层
        graphicsLayer.addGraphic(billboardGraphic)
      }

      function flyTo(type) {
        switch (type) {
          case 'TERRAIN':
            // 定位到地形，并调整到合适的视角
            sceneView.flyTo({
              center: [121.07, 24.05, 10000.0],
              duration: 0,
              orientation: {
                heading: Cesium.Math.toRadians(0), // 方位角
                pitch: Cesium.Math.toRadians(-30), // 俯仰角
                roll: Cesium.Math.toRadians(0) // 翻滚角
              }
            })
            break
          case 'MODEL':
            // 定位到模型，并调整到合适的视角
            sceneView.flyTo({
              center: [108.9595, 34.2165, 200.0],
              duration: 0,
              orientation: {
                heading: Cesium.Math.toRadians(0), // 方位角
                pitch: Cesium.Math.toRadians(-30), // 俯仰角
                roll: Cesium.Math.toRadians(0) // 翻滚角
              }
            })
        }
      }

      function initUI() {
        pane = new Pane({
          title: '操作面板'
        })

        const controls = {
          viewshedVisibleRate
        }

        const viewshedOptionsFolder = pane.addFolder({
          title: '可视域配置面板'
        })
        const viewshedAnalysisFolder = pane.addFolder({
          title: '可视域分析面板'
        })
        const viewshedOperationFolder = pane.addFolder({
          title: '可视域操作面板'
        })

        computeViewshedVisibleRate(controls)

        viewshedOptionsFolder
          .addBlade({
            view: 'list',
            label: '切换类型',
            options: [
              {
                text: '模型',
                value: 'MODEL'
              },
              {
                text: '地形',
                value: 'TERRAIN'
              }
            ],
            value: 'MODEL'
          })
          .on('change', (e) => {
            currentType = e.value
            flyTo(currentType)
          })

        viewshedOptionsFolder
          .addBlade({
            view: 'list',
            label: '渲染通道',
            options: [
              {
                text: '模型缓存渲染后',
                value: 'AFTER_TILE'
              },
              {
                text: '地球渲染后',
                value: 'AFTER_GLOBE'
              },
              {
                text: '模型缓存覆盖物渲染后',
                value: 'AFTER_TILE_CLASSIFICATION'
              },
              {
                text: '分析通道',
                value: 'ANALYSIS'
              }
            ],
            value: 'AFTER_TILE'
          })
          .on('change', (e) => {
            let visualAnalysisValues =
              viewer.scene.visualAnalysisManager.getAll()
            // 为每个可视域分析对象设置渲染通道
            for (let i = 0; i < visualAnalysisValues.length; i++) {
              if (visualAnalysisValues[i] instanceof Cesium.ViewshedAnalysis) {
                visualAnalysisValues[i].pass = Cesium.Pass[e.value]
              }
            }
          })

        viewshedAnalysisFolder.addBinding(controls, 'viewshedVisibleRate', {
          label: '可视率(%)',
          readonly: true
        })

        viewshedOperationFolder
          .addButton({
            title: '绘制可视域'
          })
          .on('click', () => {
            addViewShed()
          })

        viewshedOperationFolder
          .addButton({
            title: '固定参数添加可视域'
          })
          .on('click', () => {
            addViewShedByOption()
          })

        viewshedOperationFolder
          .addButton({
            title: '移除所有可视域'
          })
          .on('click', () => {
            removeViewShed()
            controls.viewshedVisibleRate = 0
          })
      }

      function addTDT() {
        let TDTLayer = new zondy.layer.WMTSLayer({
          // 加载经纬度的影像地图
          url: 'http://t6.tianditu.gov.cn/img_c/wmts',
          // 天地图必须加token，且token名为tk
          tokenKey: 'tk',
          // token请在天地图官网申请
          tokenValue: getTDTToken()
        })
        map.add(TDTLayer)
      }

      // 地图初始化函数
      function init() {
        // 初始化三维球体
        initViewer()
        // 创建切换Cesium版本的按钮
        createChangeTab()
        // 添加模型
        addModel()
        // 添加地形
        addTerrain()
        // 添加一个Billboard，用于测试自定义渲染通道
        addBillboard()
        // 加载天地图
        addTDT()
        // 初始化示例UI
        initUI()
        // 初始视角
        flyTo(currentType)
        // 添加鼠标操作事件
        addCesiumScreenSpaceEventHandler()
      }

      init()
    </script>
    <style>
      #mapgis-3d-viewer {
        position: absolute;
        left: 0;
        top: 0;
      }
    </style>
  </head>

  <body>
    <div id="mapgis-3d-viewer"></div>
  </body>
</html>
