<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>压平分析</title>
    <!--加载不同版本Cesium库-->
    <script src="http://10.10.130.72:8086/static/libs/loadCesium.js"></script>
    <!--plugin脚本库-->
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-common.min.js"></script>
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-cesium-plugin.min.js"></script>
    <!--示例公共样式-->
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/css/style.css"
    />
  </head>

  <body>
    <div id="mapgis-3d-viewer"></div>
    <div id="app-tips">提示：10.7.2.10版本不支持3D Tiles压平</div>
    <script type="module">
      'use strict'
      import { Pane } from 'http://10.10.130.72:8086/static/libs/cdn/tweakpane/tweakpane.min.js'

      // 定义三维视图的主要类
      let map, sceneView, viewer, tileset, pane
      // 压平工具
      let flattenTool = null
      // 绘制多边形的工具
      let drawElement = null
      // 绘制的polygon
      let polygon = null
      // 绘制的polygon的points
      let positions = null
      // 压平高度
      let height = 0
      // 是否开启根据ID压平
      let flattenWithId = false

      // 定义默认的模型URL
      const DEFAULT_URL = {
        MAPGIS_M3D_21:
          'http://10.10.130.72:8200/3DData/ModelCache/M3D/2.1/景观_建筑模型/景观_建筑模型.mcj',
        CESIUM_3DTILES_10:
          'http://10.10.130.72:8200/3DData/ModelCache/3DTileset/1.0/景观_建筑模型/tileset.json'
      }

      let currentCesiumVersion = localStorage.getItem('currentCesiumVersion')

      // 初始化球体
      function initViewer() {
        // 初始化图层管理容器
        map = new zondy.Map()
        // 初始化地图视图对象
        sceneView = new zondy.cesium.SceneView({
          // 视图id
          viewId: 'mapgis-3d-viewer',
          // 图层管理容器
          map: map
        })
        // 获取视图对象
        viewer = sceneView.getInnerView()
      }

      async function loadTileset(url, type) {
        viewer.scene.primitives.remove(tileset)
        if (type === 'M3D') {
          tileset = await zondy.cesium.MapGISM3DSet.fromUrl(url, {
            _scene: viewer.scene,
            maximumScreenSpaceError: 0
          })
        } else if (type === '3DTILES') {
          tileset = await zondy.cesium.Cesium3DTileset.fromUrl(url, {
            maximumScreenSpaceError: 0
          })
        }
        viewer.scene.primitives.add(tileset)
        viewer.zoomTo(tileset)
      }

      // 绘制工具
      function addDrawElement() {
        if (drawElement === null) {
          drawElement = new zondy.cesium.DrawElement(viewer)
        }
        // 先关闭压平分析
        removeFlatten()
        // 利用DrawElement接口，获取一个矩形的东西南北坐标
        drawElement.startDrawingPolygon({
          callback: function (result) {
            // 得到绘制矩形接口返回的范围extent，并计算出东南西北点坐标
            positions = result.positions
            // 为了演示，增加一个绘制区域
            addDrawPolygon()
            // 开启压平
            addFlatten()
            // 停止绘制，解除鼠标行为
            drawElement.stopDrawing()
          }
        })
      }

      // 创建压平工具
      function initFlattenTool() {
        // 参考API: http://10.10.130.72:8086/static/modules/cesium/api/cesium/FlattenTool.html
        flattenTool = new Cesium.FlattenTool(viewer.scene)
      }

      // 开启压平
      function addFlatten() {
        if (flattenTool && positions) {
          flattenTool.modelFlatten(positions, height, flattenWithId)
        }
      }

      // 关闭压平
      function removeFlatten() {
        if (flattenTool) {
          flattenTool.removeModelFlatten()
        }
        // 移除绘制区域
        removeDrawPolygon()
        // 清空选取的坐标点
        positions = null
      }

      // 添加绘制区域
      function addDrawPolygon() {
        if (polygon) {
          removeDrawPolygon()
        }
        // 参考API: http://10.10.130.72:8086/static/modules/cesium/api/cesium-mapgis/DrawElement.html
        polygon = new zondy.cesium.DrawElement.PolygonPrimitive({
          positions: positions,
          material: Cesium.Material.fromType('Color', {
            color: new Cesium.Color(249 / 255, 177 / 255, 27 / 255, 0.5)
          })
        })
        viewer.scene.primitives.add(polygon)
      }

      // 移除绘制区域
      function removeDrawPolygon() {
        if (polygon) {
          viewer.scene.primitives.remove(polygon)
          polygon = null
        }
      }

      // 初始化UI操作面板
      function initUI() {
        pane = new Pane({
          title: '操作面板'
        })

        const controls = {
          height: 0,
          flattenWithId: false
        }

        const modelCacheBladeFolder = pane.addFolder({
          title: '模型缓存类型'
        })

        const modelFlattenFolder = pane.addFolder({
          title: '压平操作选项'
        })

        const modelTypeList = modelCacheBladeFolder
          .addBlade({
            view: 'list',
            label: '切换类型',
            options: [
              {
                text: 'MapGIS M3D',
                value: 'M3D'
              },
              {
                text: 'Cesium 3D Tiles',
                value: '3DTILES'
              }
            ],
            value: 'M3D'
          })
          .on('change', (e) => {
            removeFlatten()
            initFlattenTool()
            if (e.value === 'M3D') {
              loadTileset(DEFAULT_URL.MAPGIS_M3D_21, 'M3D')
            } else if (e.value === '3DTILES') {
              loadTileset(DEFAULT_URL.CESIUM_3DTILES_10, '3DTILES')
            }
          })

        if (currentCesiumVersion === '10.7.2.10') {
          modelTypeList.disabled = true
        }

        const M3DModelList = modelCacheBladeFolder
          .addBlade({
            view: 'list',
            label: 'M3D',
            options: [
              {
                text: '景观模型-M3D 2.1-文件服务',
                value: DEFAULT_URL.MAPGIS_M3D_21
              }
            ],
            value: DEFAULT_URL.MAPGIS_M3D_21
          })
          .on('change', (e) => {})

        const cesium3DTilesModelList = modelCacheBladeFolder
          .addBlade({
            hidden: true,
            view: 'list',
            label: '3D Tiles',
            options: [
              {
                text: '景观模型-3D Tiles 1.0-文件服务',
                value: DEFAULT_URL.CESIUM_3DTILES_10
              }
            ],
            value: DEFAULT_URL.CESIUM_3DTILES_10
          })
          .on('change', (e) => {})

        modelFlattenFolder
          .addBinding(controls, 'height', {
            label: '高度',
            min: -20,
            max: 20
          })
          .on('change', (e) => {
            height = e.value
            addFlatten()
          })

        modelFlattenFolder
          .addBinding(controls, 'flattenWithId', {
            label: '使用ID'
          })
          .on('change', (e) => {
            flattenWithId = e.value
            addFlatten()
          })

        pane
          .addButton({
            title: '绘制区域'
          })
          .on('click', () => {
            addDrawElement()
          })

        pane
          .addButton({
            title: '清除压平'
          })
          .on('click', () => {
            removeFlatten()
          })
      }

      // 地图初始化函数
      function init() {
        // 初始化球体
        initViewer()
        // 创建切换Cesium版本的按钮
        createChangeTab()
        // 加载默认的3D模型
        loadTileset(DEFAULT_URL.MAPGIS_M3D_21, 'M3D')
        // 创建压平工具
        initFlattenTool()
        // 初始化UI操作面板
        initUI()
      }

      init()
    </script>
    <style>
      #mapgis-3d-viewer {
        position: absolute;
        left: 0;
        top: 0;
      }
      #app-tips {
        position: absolute;
        top: 10px;
        left: 10px;
        background: #28292e;
        color: #f5f5f5;
        padding: 5px;
        user-select: none;
        font-size: 12px;
        border-radius: 2px;
      }
    </style>
  </body>
</html>
