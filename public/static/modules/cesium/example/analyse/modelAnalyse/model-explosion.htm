<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>模型爆炸</title>
    <!--加载不同版本Cesium库-->
    <script src="http://10.10.130.72:8086/static/libs/loadCesium.js"></script>
    <!--plugin脚本库-->
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-common.min.js"></script>
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-cesium-plugin.min.js"></script>
    <!--示例公共样式-->
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/css/style.css"
    />
  </head>

  <body>
    <div id="mapgis-3d-viewer"></div>
    <div id="app-tips">
      提示：10.7.2.10版本不支持3D Tiles爆炸及爆炸动画参数设置
    </div>
  </body>

  <script type="module">
    'use strict'
    import { Pane } from 'http://10.10.130.72:8086/static/libs/cdn/tweakpane/tweakpane.min.js'

    // 定义三维视图的主要类
    let map, sceneView, viewer
    // 模型爆炸的工具
    let modelExplosionTool = null
    // 模型数组
    let modelList = []
    // UI组件对象
    let pane
    // 瓦片集对象
    let tileset
    // 瓦片集对象的类型
    let modelType
    // 模型爆炸参数
    let explosionOptions

    // 定义默认的模型URL
    const DEFAULT_URL = {
      MAPGIS_M3D_20:
        'http://10.10.130.72:8200/3DData/ModelCache/M3D/2.0/wujiangdizhiti/wujiangdizhiti.mcj',
      MAPGIS_M3D_21:
        'http://10.10.130.72:8200/3DData/ModelCache/M3D/2.1/wujiangdizhiti_21/wujiangdizhiti_21.mcj',
      CESIUM_3DTILES_10:
        'http://10.10.130.72:8200/3DData/ModelCache/3DTileset/1.0/wujiangdizhiti_att/tileset.json'
    }

    // 定义默认的模型爆炸参数
    const modelExplosionOptions = {
      MAPGIS_M3D_20: [
        {
          valueGroups: [
            {
              value: 1,
              distance: 800
            }
          ],
          moveDirection: new Cesium.Cartesian3(0, 1, 0),
          type: 'unique',
          field: 'OID'
        },
        {
          valueGroups: [
            {
              value: 1,
              direction: new Cesium.Cartesian3(800, 0, 0)
            },
            {
              value: 2,
              direction: new Cesium.Cartesian3(-800, 0, 0)
            },
            {
              value: 4,
              direction: new Cesium.Cartesian3(0, 0, 800)
            },
            {
              value: 7,
              direction: new Cesium.Cartesian3(0, 0, -800)
            }
          ],
          type: 'unique',
          field: 'OID'
        },
        {
          valueGroups: [
            {
              start: 1,
              end: 4,
              distance: 800
            }
          ],
          moveDirection: new Cesium.Cartesian3(0, 1, 0),
          type: 'range',
          field: 'OID'
        },
        {
          valueGroups: [
            {
              start: 1,
              end: 4,
              direction: new Cesium.Cartesian3(600, 0, 0)
            },
            {
              start: 5,
              end: 8,
              direction: new Cesium.Cartesian3(-600, 0, 0)
            }
          ],
          type: 'range',
          field: 'OID'
        },
        {
          valueGroups: [
            {
              value: '1',
              distance: 800
            },
            {
              value: '2',
              distance: 400
            }
          ],
          moveDirection: new Cesium.Cartesian3(0, 1, 0),
          type: 'contain',
          field: 'Floor'
        },
        {
          valueGroups: [
            {
              value: '1',
              direction: new Cesium.Cartesian3(800, 0, 0)
            },
            {
              value: '2',
              direction: new Cesium.Cartesian3(-800, 0, 0)
            }
          ],
          type: 'contain',
          field: 'Floor'
        }
      ],
      MAPGIS_M3D_21: [
        {
          valueGroups: [
            {
              value: 0,
              distance: 1100
            },
            {
              value: 1,
              distance: 900
            },
            {
              value: 2,
              distance: 750
            },
            {
              value: 3,
              distance: 600
            },
            {
              value: 4,
              distance: 450
            },
            {
              value: 5,
              distance: 300
            },
            {
              value: 6,
              distance: 200
            },
            {
              value: 7,
              distance: 0
            }
          ],
          moveDirection: new Cesium.Cartesian3(0, 1, 0),
          type: 'unique',
          field: 'tid'
        },
        {
          valueGroups: [
            {
              value: 0,
              direction: new Cesium.Cartesian3(1000, 0, 0)
            },
            {
              value: 1,
              direction: new Cesium.Cartesian3(0, 0, 1000)
            },
            {
              value: 3,
              direction: new Cesium.Cartesian3(-1000, 0, 0)
            },
            {
              value: 6,
              direction: new Cesium.Cartesian3(0, 0, -1000)
            }
          ],
          type: 'unique',
          field: 'tid'
        },
        {
          valueGroups: [
            {
              start: 0,
              end: 3,
              distance: 600
            }
          ],
          moveDirection: new Cesium.Cartesian3(0, 1, 0),
          type: 'range',
          field: 'tid'
        },
        {
          valueGroups: [
            {
              start: 0,
              end: 3,
              direction: new Cesium.Cartesian3(1000, 0, 0)
            },
            {
              start: 4,
              end: 6,
              direction: new Cesium.Cartesian3(0, 0, 1000)
            }
          ],
          moveDirection: new Cesium.Cartesian3(0, 1, 0),
          type: 'range',
          field: 'tid'
        },
        {
          valueGroups: [
            {
              value: 'BottomFace',
              distance: -600
            }
          ],
          moveDirection: new Cesium.Cartesian3(0, 1, 0),
          type: 'contain',
          field: 'LayerName'
        },
        {
          valueGroups: [
            {
              value: 'BottomFace',
              direction: new Cesium.Cartesian3(800, 0, 800)
            }
          ],
          moveDirection: new Cesium.Cartesian3(0, 1, 0),
          type: 'contain',
          field: 'LayerName'
        }
      ],
      CESIUM_3DTILES_10: [
        {
          valueGroups: [
            {
              value: 3,
              distance: 800
            }
          ],
          moveDirection: new Cesium.Cartesian3(0, 0, 1),
          type: 'unique',
          field: 'ID'
        },
        {
          valueGroups: [
            {
              value: 3,
              direction: new Cesium.Cartesian3(800, 0, 0)
            },
            {
              value: 4,
              direction: new Cesium.Cartesian3(-800, 0, 0)
            },
            {
              value: 2,
              direction: new Cesium.Cartesian3(0, 800, 0)
            },
            {
              value: 0,
              direction: new Cesium.Cartesian3(0, -800, 0)
            }
          ],
          type: 'unique',
          field: 'ID'
        },
        {
          valueGroups: [
            {
              start: 2,
              end: 4,
              distance: 800
            }
          ],
          moveDirection: new Cesium.Cartesian3(0, 0, 1),
          type: 'range',
          field: 'ID'
        },
        {
          valueGroups: [
            {
              start: 2,
              end: 5,
              direction: new Cesium.Cartesian3(600, 0, 0)
            },
            {
              start: 0,
              end: 1,
              direction: new Cesium.Cartesian3(-600, 0, 0)
            }
          ],
          type: 'range',
          field: 'ID'
        },
        {
          valueGroups: [
            {
              value: 3,
              distance: 800
            },
            {
              value: 4,
              distance: 400
            }
          ],
          moveDirection: new Cesium.Cartesian3(0, 0, 1),
          type: 'unique',
          field: 'Floor'
        },
        {
          valueGroups: [
            {
              value: 3,
              direction: new Cesium.Cartesian3(0, 800, 0)
            },
            {
              value: 4,
              direction: new Cesium.Cartesian3(800, 0, 0)
            }
          ],
          type: 'unique',
          field: 'Floor'
        }
      ]
    }

    let currentCesiumVersion = localStorage.getItem('currentCesiumVersion')

    // 初始化三维球体
    function initViewer() {
      // 初始化图层管理容器
      map = new zondy.Map()
      // 初始化地图视图对象
      sceneView = new zondy.cesium.SceneView({
        // 视图id
        viewId: 'mapgis-3d-viewer',
        // 图层管理容器
        map: map
      })
      // 获取视图对象
      viewer = sceneView.getInnerView()
      viewer.scene.skyBox.show = false
      viewer.scene.skyAtmosphere.show = false
      viewer.scene.sun.show = false
      viewer.scene.moon.show = false
      viewer.scene.globe.showGroundAtmosphere = false
      viewer.scene.globe.show = false
    }

    // 初始化爆炸工具
    function initExplosionTool() {
      // 参考API: http://10.10.130.72:8086/static/modules/cesium/api/cesium/ModelExplosion.html
      modelExplosionTool = new Cesium.ModelExplosion(viewer)
    }

    async function loadTileset(url, type) {
      viewer.scene.primitives.remove(tileset)
      if (type === 'M3D') {
        tileset = await zondy.cesium.MapGISM3DSet.fromUrl(url, {
          _scene: viewer.scene
        })
        // 切换数据后设置默认的爆炸参数
        if (currentCesiumVersion === '10.7.2.10') {
          explosionOptions = modelExplosionOptions.MAPGIS_M3D_21[0]
        } else {
          explosionOptions = modelExplosionOptions.MAPGIS_M3D_20[0]
        }
      } else if (type === '3DTILES') {
        tileset = await zondy.cesium.Cesium3DTileset.fromUrl(url)
        // 切换数据后设置默认的爆炸参数
        explosionOptions = modelExplosionOptions.CESIUM_3DTILES_10[0]
      }
      modelType = type
      viewer.scene.primitives.add(tileset)
      viewer.zoomTo(
        tileset,
        new Cesium.HeadingPitchRange(0, -Math.PI / 4, 5000)
      )
    }

    function initUI() {
      pane = new Pane({
        title: '操作面板'
      })

      const controls = {
        enableFrameFunction: false,
        duration: 0
      }

      const modelCacheBladeFolder = pane.addFolder({
        title: '模型缓存类型'
      })

      const modelExplosionTypeFolder = pane.addFolder({
        title: '模型爆炸类型'
      })

      const modelExplosionOptionsFolder = pane.addFolder({
        title: '模型爆炸选项'
      })

      const modelTypeList = modelCacheBladeFolder
        .addBlade({
          view: 'list',
          label: '切换类型',
          options: [
            {
              text: 'MapGIS M3D',
              value: 'M3D'
            },
            {
              text: 'Cesium 3D Tiles',
              value: '3DTILES'
            }
          ],
          value: 'M3D'
        })
        .on('change', (e) => {
          if (e.value === 'M3D') {
            cesium3DTilesModelList.hidden = true
            M3DModelList.hidden = false
            loadTileset(DEFAULT_URL.MAPGIS_M3D_20, 'M3D')
          } else if (e.value === '3DTILES') {
            cesium3DTilesModelList.hidden = false
            M3DModelList.hidden = true
            loadTileset(DEFAULT_URL.CESIUM_3DTILES_10, '3DTILES')
          }
          resetComponents()
        })

      if (currentCesiumVersion === '10.7.2.10') {
        modelTypeList.disabled = true
        modelExplosionOptionsFolder.hidden = true
      }

      let M3DModelList = undefined

      if (currentCesiumVersion === '10.7.2.10') {
        M3DModelList = modelCacheBladeFolder
          .addBlade({
            view: 'list',
            label: 'M3D',
            options: [
              {
                text: '地质体-M3D 2.1-文件服务',
                value: DEFAULT_URL.MAPGIS_M3D_21
              }
            ],
            value: DEFAULT_URL.MAPGIS_M3D_21
          })
          .on('change', (e) => {})
      } else {
        M3DModelList = modelCacheBladeFolder
          .addBlade({
            view: 'list',
            label: 'M3D',
            options: [
              {
                text: '地质体-M3D 2.0-文件服务',
                value: DEFAULT_URL.MAPGIS_M3D_20
              }
            ],
            value: DEFAULT_URL.MAPGIS_M3D_20
          })
          .on('change', (e) => {})
      }

      const cesium3DTilesModelList = modelCacheBladeFolder
        .addBlade({
          hidden: true,
          view: 'list',
          label: '3D Tiles',
          options: [
            {
              text: '地质体-3D Tiles 1.0-文件服务',
              value: DEFAULT_URL.CESIUM_3DTILES_10
            }
          ],
          value: DEFAULT_URL.CESIUM_3DTILES_10
        })
        .on('change', (e) => {})

      const modelExplosionType = modelExplosionTypeFolder
        .addBlade({
          view: 'list',
          label: '爆炸方式',
          options: [
            {
              text: '单值过滤-单方向',
              value: 0
            },
            {
              text: '单值过滤-多方向',
              value: 1
            },
            {
              text: '分段过滤-单方向',
              value: 2
            },
            {
              text: '分段过滤-多方向',
              value: 3
            },
            {
              text: '属性过滤-单方向',
              value: 4
            },
            {
              text: '属性过滤-多方向',
              value: 5
            }
          ],
          value: 0
        })
        .on('change', (e) => {
          if (modelType === 'M3D') {
            if (currentCesiumVersion === '10.7.2.10') {
              explosionOptions = modelExplosionOptions.MAPGIS_M3D_21[e.value]
            } else {
              explosionOptions = modelExplosionOptions.MAPGIS_M3D_20[e.value]
            }
          } else if (modelType === '3DTILES') {
            explosionOptions = modelExplosionOptions.CESIUM_3DTILES_10[e.value]
          }
        })

      modelExplosionOptionsFolder.addBinding(controls, 'enableFrameFunction', {
        label: '实时爆炸'
      })

      modelExplosionOptionsFolder.addBinding(controls, 'duration', {
        label: '持续时间',
        min: 0,
        max: 10
      })

      pane
        .addButton({
          title: '开启爆炸'
        })
        .on('click', () => {
          explosionOptions.enableFrameFunction = controls.enableFrameFunction
          // 设置爆炸持续时间，将秒转换为毫秒
          explosionOptions.duration = controls.duration * 1000
          modelExplosionTool.explosionByField([tileset], explosionOptions)
        })

      pane
        .addButton({
          title: '关闭爆炸'
        })
        .on('click', () => {
          modelExplosionTool.resetExplosionByField([tileset])
        })

      function resetComponents() {
        controls.enableFrameFunction = false
        controls.duration = 0
        modelExplosionType.value = 0
        pane.refresh()
      }
    }

    function init() {
      initViewer()
      createChangeTab()
      let url = undefined
      if (currentCesiumVersion === '10.7.2.10') {
        url = DEFAULT_URL.MAPGIS_M3D_21
      } else {
        url = DEFAULT_URL.MAPGIS_M3D_20
      }
      loadTileset(url, 'M3D')
      initExplosionTool()
      initUI()
    }

    init()
  </script>

  <style>
    #mapgis-3d-viewer {
      position: absolute;
      left: 0;
      top: 0;
    }
    .tp-dfwv {
      position: absolute;
      top: 10px;
      right: 10px;
    }
    #app-tips {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #28292e;
      color: #f5f5f5;
      padding: 5px;
      user-select: none;
      font-size: 12px;
      border-radius: 2px;
    }
  </style>
</html>
