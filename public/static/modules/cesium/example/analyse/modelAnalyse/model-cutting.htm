<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>动态剖切</title>
    <!--加载不同版本Cesium库-->
    <script src="http://10.10.130.72:8086/static/libs/loadCesium.js"></script>
    <!--plugin脚本库-->
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-common.min.js"></script>
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-cesium-plugin.min.js"></script>
    <script src="http://10.10.130.72:8086/static/assets/js/TDT-token.js"></script>
    <!--引入Cesium.js库相关css样式-->
    <script src="http://10.10.130.72:8086/static/libs/cdn/layui/layui.js"></script>
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/cdn/layui/css/layui.css"
    />
    <!--示例公共样式-->
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/css/style.css"
    />
  </head>

  <body>
    <div id="mapgis-3d-viewer"></div>
    <div id="app-tips">
      提示：10.7.2.10暂不支持加载3D Tiles 1.1，也不支持在3D Tiles上进行区域裁剪
    </div>

    <script type="module">
      'use strict'
      import { Pane } from 'http://10.10.130.72:8086/static/libs/cdn/tweakpane/tweakpane.min.js'

      // 定义创建图层与UI交互相关的变量
      let map,
        sceneView,
        viewer,
        cutTool,
        drawElement,
        pane,
        pnts = []

      // 定义绘制裁剪区域的默认裁剪方向
      let clipReverse = true

      // 该方法用于初始化三维地图查看器，包括创建图层管理容器，初始化地图视图对象以及获取Cesium场景视图对象
      function initViewer() {
        map = new zondy.Map()
        sceneView = new zondy.cesium.SceneView({
          viewId: 'mapgis-3d-viewer',
          map: map
        })
        viewer = sceneView.getInnerView()

        // 去除场景中的其他要素
        viewer.scene.skyBox.show = false
        viewer.scene.skyAtmosphere.show = false
        viewer.scene.sun.show = false
        viewer.scene.moon.show = false
        viewer.scene.globe.showGroundAtmosphere = false
        viewer.scene.globe.show = false

        // 创建绘制工具
        // 参考API: http://10.10.130.72:8086/static/modules/cesium/api/cesium-mapgis/DrawElement.html
        drawElement = new zondy.cesium.DrawElement(viewer)
      }

      /**
       * 该方法用于添加模型缓存图层，根据模型缓存类型创建对应的模型缓存图层对象
       * @param {string} url - 模型缓存文件的URL地址
       * @param {string} modelType - 模型缓存类型，可选值为'M3D'或'3DTILES'
       */
      function addModelCacheLayer(url, modelType) {
        const lastLayer = layer
        let modelCacheLayer = undefined

        if (modelType === 'M3D') {
          modelCacheLayer = new zondy.layer.M3DModelCacheLayer({
            url,
            extensionOptions: {
              autoReset: true
            }
          })
        } else if (modelType === '3DTILES') {
          modelCacheLayer = new zondy.layer.Cesium3DTilesCacheLayer({
            url,
            extensionOptions: {
              autoReset: true
            }
          })
        }

        if (modelCacheLayer) {
          map.add(modelCacheLayer)
          // 图层加载完毕的回调方法
          modelCacheLayer.on('layerview-created', function (result) {
            // 获取内部图层对象，即MapGISM3DSet或Cesium3DTileset对象
            layer = sceneView.getInnerLayer(result.layer)
            // 在添加模型缓存图层后，要移除之前的模型缓存图层
            if (viewer.scene.primitives.contains(lastLayer)) {
              viewer.scene.primitives.remove(lastLayer)
            }
            removeCuttingPlane()
            // 参考API: http://10.10.130.72:8086/static/modules/cesium/api/cesium-mapgis/CuttingTool.html
            cutTool = new zondy.cesium.CuttingTool(viewer, [layer])
          })
        }
      }

      // 该方法用于添加剖切面
      function addCuttingPlane() {
        removeCuttingPlane()
        cutTool.createModelCuttingPlane(new Cesium.Cartesian3(1.0, 0.0, 0.0), {
          distance: 0,
          scaleWidth: 2.5,
          scaleHeight: 2.5,
          unionClippingRegions: false,
          color: new Cesium.Color(1, 1, 1, 0.2),
          showCuttingPlane: true
        })
      }

      // 该方法用于绘制单个剖切面
      function drawSingleClippingPlane() {
        removeCuttingPlane()
        drawElement.startDrawingPolyline({
          callback: function (result) {
            let positions = result.positions
            let c1 = Cesium.Cartographic.fromCartesian(positions[0])
            let c2 = Cesium.Cartographic.fromCartesian(positions[1])
            let p1 = new Cesium.Cartesian3(
              Cesium.Math.toDegrees(c1.longitude),
              Cesium.Math.toDegrees(c1.latitude),
              c1.height
            )
            let p2 = new Cesium.Cartesian3(
              Cesium.Math.toDegrees(c2.longitude),
              Cesium.Math.toDegrees(c2.latitude),
              c2.height
            )
            cutTool.createModelCuttingPlaneFromLine(p1, p2, {
              unionClippingRegions: false,
              color: new Cesium.Color(1, 1, 1, 0.2),
              showCuttingPlane: true,
              scaleWidth: 2.5,
              scaleHeight: 2.5
            })
            drawElement.stopDrawing()
          }
        })
      }

      // 该方法用于绘制多个剖切面
      function drawMultiClippingPlane() {
        removeCuttingPlane()
        drawElement.startDrawingPolyline({
          callback: function (result) {
            let positions = result.positions
            let lines = []
            for (let i = 0; i < positions.length; i++) {
              let tempPoint = Cesium.Cartographic.fromCartesian(positions[i])
              lines.push(
                new Cesium.Cartesian3(
                  Cesium.Math.toDegrees(tempPoint.longitude),
                  Cesium.Math.toDegrees(tempPoint.latitude),
                  tempPoint.height
                )
              )
            }
            cutTool.createModelCuttingPlaneFromPolyline(lines, {
              unionClippingRegions: false
            })
            drawElement.stopDrawing()
          }
        })
      }

      // 该方法用于绘制裁剪区域
      function drawCuttingPolygon() {
        removeCuttingPlane()
        drawElement.startDrawingPolygon({
          callback: function (result) {
            let positions = result.positions
            pnts = []
            for (let i = 0; i < positions.length; i++) {
              let position = positions[i]
              let c1 = Cesium.Cartographic.fromCartesian(position)
              pnts.push(Cesium.Math.toDegrees(c1.longitude))
              pnts.push(Cesium.Math.toDegrees(c1.latitude))
            }
            cutTool.createModelCuttingPolygon(pnts, -500, 500, {
              unionClippingRegions: clipReverse,
              color: new Cesium.Color(1, 1, 1, 0.2),
              showCuttingPlane: true
            })
            drawElement.stopDrawing()
          }
        })
      }

      // 该方法用于移除所有剖切面
      function removeCuttingPlane() {
        if (cutTool) {
          cutTool.removeAll()
        }
        if (drawElement) {
          drawElement.stopDrawing()
        }
      }

      // 该方法用于初始化UI操作面板
      function initUI() {
        pane = new Pane({
          title: '操作面板'
        })
        const modelCacheBladeFolder = pane.addFolder({
          title: '模型缓存类型'
        })
        const clippingPlaneDrawFolder = pane.addFolder({
          title: '剖切面绘制'
        })
        const clippingPlaneControlFolder = pane.addFolder({
          title: '剖切面控制'
        })
        const clippingPolygonControlFolder = pane.addFolder({
          title: '裁剪区域控制'
        })

        // 定义默认参数
        const paneParameters = {
          clipReverse,
          clippingDistance: 0,
          clippingPlaneColor: { r: 255, g: 255, b: 255, a: 0.5 },
          clippingMinHeight: -500,
          clippingMaxHeight: 500
        }

        // 该控件允许用户在MapGIS M3D和Cesium 3D Tiles两种模型类型之间切换
        const modelTypeList = modelCacheBladeFolder
          .addBlade({
            view: 'list',
            label: '切换类型',
            options: [
              {
                text: 'MapGIS M3D',
                value: 'M3D'
              },
              {
                text: 'Cesium 3D Tiles',
                value: '3DTILES'
              }
            ],
            value: 'M3D'
          })
          .on('change', (e) => {
            // 根据选择的模型类型切换显示对应的模型列表并加载模型数据
            if (e.value === 'M3D') {
              cesium3DTilesModelList.hidden = true
              M3DModelList.hidden = false
              addModelCacheLayer(
                'http://10.10.130.72:8200/3DData/ModelCache/M3D/2.0/wujiangdizhiti/wujiangdizhiti.mcj',
                'M3D'
              )
            } else if (e.value === '3DTILES') {
              cesium3DTilesModelList.hidden = false
              M3DModelList.hidden = true
              addModelCacheLayer(
                'http://10.10.130.72:8200/3DData/ModelCache/3DTileset/1.0/wujiangdizhiti/tileset.json',
                '3DTILES'
              )
            }
            resetComponents()
          })

        // 定义MapGIS M3D的模型缓存列表
        const M3DModelList = modelCacheBladeFolder
          .addBlade({
            view: 'list',
            label: 'M3D',
            options: [
              {
                text: '地质体-M3D 2.0-文件服务',
                value:
                  'http://10.10.130.72:8200/3DData/ModelCache/M3D/2.0/wujiangdizhiti/wujiangdizhiti.mcj'
              },
              {
                text: '地质体-M3D 2.0-M3DServer',
                value:
                  'http://10.10.130.72:8089/igs/rest/services/M3Dv2/地质体封边模型/M3dServer'
              }
            ],
            value:
              'http://10.10.130.72:8200/3DData/ModelCache/M3D/2.0/wujiangdizhiti/wujiangdizhiti.mcj'
          })
          .on('change', (e) => {
            addModelCacheLayer(e.value, 'M3D')
            resetComponents()
          })

        // 定义Cesium 3D Tiles的模型缓存列表
        const cesium3DTilesModelList = modelCacheBladeFolder
          .addBlade({
            hidden: true,
            view: 'list',
            label: '3D Tiles',
            options: [
              {
                text: '地质体-3D Tiles 1.0-文件服务',
                value:
                  'http://10.10.130.72:8200/3DData/ModelCache/3DTileset/1.0/wujiangdizhiti/tileset.json'
              },
              {
                text: '地质体-3D Tiles 1.1-文件服务',
                value:
                  'http://10.10.130.72:8200/3DData/ModelCache/3DTileset/1.1/wujiangdizhiti/tileset.json'
              }
            ],
            value:
              'http://10.10.130.72:8200/3DData/ModelCache/3DTileset/1.0/wujiangdizhiti/tileset.json'
          })
          .on('change', (e) => {
            addModelCacheLayer(e.value, '3DTILES')
            resetComponents()
          })

        clippingPlaneControlFolder
          .addButton({
            title: '添加剖切面'
          })
          .on('click', () => {
            resetComponents()
            clippingDistanceSlider.disabled = false
            clippingPlaneColorChanger.disabled = false
            addCuttingPlane()
          })

        const clippingDistanceSlider = clippingPlaneControlFolder
          .addBinding(paneParameters, 'clippingDistance', {
            disabled: true,
            label: '裁剪距离',
            min: -400,
            max: 400
          })
          .on('change', (e) => {
            if (cutTool) {
              cutTool.distance = e.value
            }
          })

        const clippingPlaneColorChanger = clippingPlaneControlFolder
          .addBinding(paneParameters, 'clippingPlaneColor', {
            disabled: true,
            label: '裁剪面颜色'
          })
          .on('change', (e) => {
            if (cutTool) {
              cutTool.changePlaneColor(
                Cesium.Color.fromBytes(
                  e.value.r,
                  e.value.g,
                  e.value.b,
                  e.value.a * 255
                )
              )
            }
          })

        clippingPlaneDrawFolder
          .addButton({
            title: '绘制单个剖切面'
          })
          .on('click', () => {
            resetComponents()
            drawSingleClippingPlane()
          })

        clippingPlaneDrawFolder
          .addButton({
            title: '绘制多个剖切面'
          })
          .on('click', () => {
            resetComponents()
            drawMultiClippingPlane()
          })

        clippingPolygonControlFolder
          .addButton({
            title: '绘制裁剪区域'
          })
          .on('click', () => {
            resetComponents()
            clippingDirectionChecker.disabled = false
            clippingMinHeightSlider.disabled = false
            clippingMaxHeightSlider.disabled = false
            drawCuttingPolygon()
          })

        const clippingDirectionChecker = clippingPolygonControlFolder
          .addBlade({
            disabled: true,
            view: 'list',
            label: '裁剪方向',
            options: [
              {
                text: '裁剪（去除）',
                value: true
              },
              {
                text: '裁剪（保留）',
                value: false
              }
            ],
            value: true
          })
          .on('change', (e) => {
            clipReverse = e.value
          })

        const clippingMinHeightSlider = clippingPolygonControlFolder
          .addBinding(paneParameters, 'clippingMinHeight', {
            disabled: true,
            label: '最小高度',
            min: -1000,
            max: 1000
          })
          .on('change', (e) => {
            if (e.value >= paneParameters.clippingMaxHeight) {
              paneParameters.clippingMinHeight =
                paneParameters.clippingMaxHeight
              pane.refresh()
            } else {
              paneParameters.clippingMinHeight = e.value
            }
            updateClippingHeight(
              paneParameters.clippingMinHeight,
              paneParameters.clippingMaxHeight
            )
          })

        const clippingMaxHeightSlider = clippingPolygonControlFolder
          .addBinding(paneParameters, 'clippingMaxHeight', {
            disabled: true,
            label: '最大高度',
            min: -1000,
            max: 1000
          })
          .on('change', (e) => {
            if (paneParameters.clippingMinHeight >= e.value) {
              paneParameters.clippingMaxHeight =
                paneParameters.clippingMinHeight
              pane.refresh()
            } else {
              paneParameters.clippingMaxHeight = e.value
            }
            updateClippingHeight(
              paneParameters.clippingMinHeight,
              paneParameters.clippingMaxHeight
            )
          })

        pane
          .addButton({
            title: '清除所有剖切面'
          })
          .on('click', () => {
            resetComponents()
            removeCuttingPlane()
          })

        // 该方法用于在去除所有剖切面时重置所有UI组件
        function resetComponents() {
          clippingDistanceSlider.disabled = true
          clippingPlaneColorChanger.disabled = true
          clippingMinHeightSlider.disabled = true
          clippingDirectionChecker.disabled = true
          clippingMaxHeightSlider.disabled = true
          // paneParameters.clipReverse = true
          paneParameters.clippingDistance = 0
          paneParameters.clippingPlaneColor = { r: 255, g: 255, b: 255, a: 0.5 }
          paneParameters.clippingMinHeight = -500
          paneParameters.clippingMaxHeight = 500
          pane.refresh()
        }

        // 该方法用于更新裁剪高度，重新创建裁剪体以及裁剪辅助面
        function updateClippingHeight(minHeight, maxHeight) {
          removeCuttingPlane()
          cutTool.createModelCuttingPolygon(pnts, minHeight, maxHeight, {
            unionClippingRegions: clipReverse,
            color: new Cesium.Color(1, 1, 1, 0.2),
            showCuttingPlane: true
          })
        }
      }

      // 该方法用于初始化整个应用，包括初始化查看器、添加模型缓存图层和初始化用户界面
      function init() {
        initViewer()
        createChangeTab()
        addModelCacheLayer(
          'http://10.10.130.72:8200/3DData/ModelCache/M3D/2.0/wujiangdizhiti/wujiangdizhiti.mcj',
          'M3D'
        )
        initUI()
      }

      init()
    </script>

    <style>
      /* 提示内容样式 */
      #app-tips {
        position: absolute;
        top: 10px;
        left: 10px;
        /* left: 50%; */
        /* transform: translateX(-50%); */
        background: #28292e;
        color: #f5f5f5;
        padding: 5px;
        user-select: none;
        font-size: 12px;
        border-radius: 2px;
      }
    </style>
  </body>
</html>
