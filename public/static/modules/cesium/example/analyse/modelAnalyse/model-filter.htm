<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>模型空间过滤工具</title>
    <!--加载不同版本Cesium库-->
    <script src="http://10.10.130.72:8086/static/libs/loadCesium.js"></script>
    <!--plugin脚本库-->
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-common.min.js"></script>
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-cesium-plugin.min.js"></script>
    <!--引入Cesium.js库相关css样式-->
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/cdn/cesium/Widgets/widgets.css"
    />
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/cdn/cesium/MapGIS/css/mapgis.css"
    />
    <!--示例公共样式-->
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/css/style.css"
    />
  </head>

  <body>
    <script type="module">
      'use strict'
      import { Pane } from 'http://10.10.130.72:8086/static/libs/cdn/tweakpane/tweakpane.min.js'

      // 定义三维视图的主要类
      let map, sceneView, viewer, pane, tileset
      // 模型编辑工具
      let modelFilterTool = null
      // 绘制工具
      let drawElement = null

      // 定义默认的模型URL
      const DEFAULT_URL = {
        MAPGIS_M3D_20:
          'http://10.10.130.72:8200/3DData/ModelCache/M3D/1.0/DaYanTa-M3D/dayanta.mcj',
        CESIUM_3DTILES_10:
          'http://10.10.130.72:8200/3DData/ModelCache/3DTileset/1.0/dayantaresult/tileset.json'
      }

      // 默认高度限制
      const DEFAULT_HEIGHT_LIMIT = {
        MAPGIS_M3D_20: {
          boundHeightMin: 30,
          boundHeightMax: 60,
          centerHeightMin: 30,
          centerHeightMax: 60
        },
        CESIUM_3DTILES_10: {
          boundHeightMin: 0,
          boundHeightMax: 500,
          centerHeightMin: 0,
          centerHeightMax: 500
        }
      }

      let defaultHeightLimit = DEFAULT_HEIGHT_LIMIT.MAPGIS_M3D_20

      // 初始化三维球体
      function initViewer() {
        // 初始化图层管理容器
        map = new zondy.Map()
        // 初始化地图视图对象
        sceneView = new zondy.cesium.SceneView({
          // 视图id
          viewId: 'mapgis-3d-viewer',
          // 图层管理容器
          map: map
        })
        // 获取视图对象
        viewer = sceneView.getInnerView()
        viewer.scene.skyBox.show = false
        viewer.scene.skyAtmosphere.show = false
        viewer.scene.sun.show = false
        viewer.scene.moon.show = false
        viewer.scene.globe.showGroundAtmosphere = false
        // viewer.scene.globe.show = false
      }

      async function loadTileset(url, type) {
        viewer.scene.primitives.remove(tileset)
        if (type === 'M3D') {
          tileset = await zondy.cesium.MapGISM3DSet.fromUrl(url, {
            _scene: viewer.scene
          })
          defaultHeightLimit = DEFAULT_HEIGHT_LIMIT.MAPGIS_M3D_20
        } else if (type === '3DTILES') {
          tileset = await zondy.cesium.Cesium3DTileset.fromUrl(url)
          defaultHeightLimit = DEFAULT_HEIGHT_LIMIT.CESIUM_3DTILES_10
        }
        viewer.scene.primitives.add(tileset)
        viewer.zoomTo(tileset)
        // 初始化模型过滤工具
        initModelFilterTool()
      }

      function createDrawElement() {
        if (drawElement === null) {
          return new zondy.cesium.DrawElement(viewer)
        } else {
          drawElement.stopDrawing()
          return drawElement
        }
      }

      function boundFilter() {
        // 清空之前的filter
        removeFilter()
        drawElement = createDrawElement()
        drawElement.startDrawingPolygon({
          callback: function (result) {
            drawElement.stopDrawing()
            let positions = result.positions
            modelFilterTool.filterWithBoundingVolume(positions)
          }
        })
      }

      function boundWithHeightFilter() {
        // 清空之前的filter
        removeFilter()
        drawElement = createDrawElement()
        drawElement.startDrawingPolygon({
          callback: function (result) {
            drawElement.stopDrawing()
            let positions = result.positions
            // 如果最小高度和最大高度不传递的话，那么过滤将忽略高度
            modelFilterTool.filterWithBoundingVolume(
              positions,
              defaultHeightLimit.boundHeightMin,
              defaultHeightLimit.boundHeightMax
            )
          }
        })
      }

      function centerFilter() {
        // 清空之前的filter
        removeFilter()
        drawElement = createDrawElement()
        drawElement.startDrawingPolygon({
          callback: function (result) {
            drawElement.stopDrawing()
            let positions = result.positions
            modelFilterTool.filterWithCenter(positions)
          }
        })
      }

      function centerWithHeightFilter() {
        // 清空之前的filter
        removeFilter()
        drawElement = createDrawElement()
        drawElement.startDrawingPolygon({
          callback: function (result) {
            drawElement.stopDrawing()
            let positions = result.positions
            // 如果最小高度和最大高度不传递的话，那么过滤将忽略高度
            modelFilterTool.filterWithCenter(
              positions,
              defaultHeightLimit.centerHeightMin,
              defaultHeightLimit.centerHeightMax
            )
          }
        })
      }

      function removeFilter() {
        if (modelFilterTool) {
          modelFilterTool.removeFilter()
        }
      }

      function initModelFilterTool() {
        modelFilterTool = new zondy.cesium.ModelFilterTool(tileset, {
          // 支持输入范围为笛卡尔坐标
          enableCartesian: true
        })
      }

      // 初始化示例UI操作
      function initUI() {
        pane = new Pane({
          title: '操作面板'
        })

        const modelCacheBladeFolder = pane.addFolder({
          title: '模型缓存类型'
        })

        const modelFilterFolder = pane.addFolder({
          title: '过滤操作选项'
        })

        const modelTypeList = modelCacheBladeFolder
          .addBlade({
            view: 'list',
            label: '切换类型',
            options: [
              {
                text: 'MapGIS M3D',
                value: 'M3D'
              },
              {
                text: 'Cesium 3D Tiles',
                value: '3DTILES'
              }
            ],
            value: 'M3D'
          })
          .on('change', (e) => {
            removeFilter()
            if (e.value === 'M3D') {
              loadTileset(DEFAULT_URL.MAPGIS_M3D_20, 'M3D')
            } else if (e.value === '3DTILES') {
              loadTileset(DEFAULT_URL.CESIUM_3DTILES_10, '3DTILES')
            }
          })

        const M3DModelList = modelCacheBladeFolder
          .addBlade({
            view: 'list',
            label: 'M3D',
            options: [
              {
                text: '大雁塔-M3D 2.0-文件服务',
                value: DEFAULT_URL.MAPGIS_M3D_20
              }
            ],
            value: DEFAULT_URL.MAPGIS_M3D_20
          })
          .on('change', (e) => {})

        const cesium3DTilesModelList = modelCacheBladeFolder
          .addBlade({
            hidden: true,
            view: 'list',
            label: '3D Tiles',
            options: [
              {
                text: '大雁塔-3D Tiles 1.0-文件服务',
                value: DEFAULT_URL.CESIUM_3DTILES_10
              }
            ],
            value: DEFAULT_URL.CESIUM_3DTILES_10
          })
          .on('change', (e) => {})

        modelFilterFolder
          .addButton({
            title: '外包盒过滤'
          })
          .on('click', () => {
            boundFilter()
          })

        modelFilterFolder
          .addButton({
            title: '外包盒过滤（带高度）'
          })
          .on('click', () => {
            boundWithHeightFilter()
          })

        modelFilterFolder
          .addButton({
            title: '中心点过滤'
          })
          .on('click', () => {
            centerFilter()
          })

        modelFilterFolder
          .addButton({
            title: '中心点过滤（带高度）'
          })
          .on('click', () => {
            centerWithHeightFilter()
          })

        pane
          .addButton({
            title: '取消过滤'
          })
          .on('click', () => {
            removeFilter()
          })
      }

      // 地图初始化函数
      function init() {
        // 初始化三维球体
        initViewer()
        // 创建切换Cesium版本的按钮
        createChangeTab()
        // 加载模型
        loadTileset(DEFAULT_URL.MAPGIS_M3D_20, 'M3D')
        // 初始化示例UI操作
        initUI()
      }

      init()
    </script>

    <div id="mapgis-3d-viewer"></div>
  </body>

  <style>
    #mapgis-3d-viewer {
      position: absolute;
      left: 0;
      top: 0;
    }
  </style>
</html>
