<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>地质体剖面</title>
    <!--加载Cesium库-->
    <script src="http://10.10.130.72:8086/static/libs/cdn/cesium/Cesium.js"></script>
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/cdn/cesium/Widgets/widgets.css"
    />
    <!--plugin脚本库-->
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-common.min.js"></script>
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-cesium-plugin.min.js"></script>
    <!--示例公共样式-->
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/css/style.css"
    />
  </head>

  <body>
    <div id="mapgis-3d-viewer"></div>
    <script type="module">
      'use strict'
      import { Pane } from 'http://10.10.130.72:8086/static/libs/cdn/tweakpane/tweakpane.min.js'

      // 定义三维视图的主要类
      let map, sceneView, viewer, pane
      // 绘制工具
      let drawElement = null
      // 模型
      let tileset = null

      // 定义默认的模型URL
      const DEFAULT_URL = {
        MAPGIS_M3D_21:
          'http://10.10.130.72:8200/3DData/ModelCache/M3D/2.0/wujiangdizhiti/wujiangdizhiti.mcj',
        CESIUM_3DTILES_10:
          'http://10.10.130.72:8200/3DData/ModelCache/3DTileset/1.0/wujiangdizhiti/tileset.json'
      }

      // 初始化球体
      function initViewer() {
        // 初始化图层管理容器
        map = new zondy.Map()
        // 初始化地图视图对象
        sceneView = new zondy.cesium.SceneView({
          // 视图id
          viewId: 'mapgis-3d-viewer',
          // 图层管理容器
          map: map
        })
        // 获取视图对象
        viewer = sceneView.getInnerView()
        viewer.scene.skyBox.show = false
        viewer.scene.skyAtmosphere.show = false
        viewer.scene.sun.show = false
        viewer.scene.moon.show = false
        viewer.scene.globe.showGroundAtmosphere = false
        viewer.scene.globe.show = false
      }

      async function loadTileset(url, type) {
        viewer.scene.primitives.remove(tileset)
        if (type === 'M3D') {
          tileset = await zondy.cesium.MapGISM3DSet.fromUrl(url, {
            _scene: viewer.scene,
            // 开启剖面几何
            hasSectionGeometry: true
          })
        } else if (type === '3DTILES') {
          tileset = await zondy.cesium.Cesium3DTileset.fromUrl(url, {
            // 开启剖面几何
            hasSectionGeometry: true
          })
        }
        viewer.scene.primitives.add(tileset)
        viewer.zoomTo(
          tileset,
          new Cesium.HeadingPitchRange(0, -Math.PI / 4, 3000)
        )
      }

      // 添加竖剖面
      function addVerticalSection() {
        // 先移除上次的切面
        removeSection()
        // 创建交互绘制工具
        drawElement = new zondy.cesium.DrawElement(viewer)
        drawElement.startDrawingPolyline({
          callback: function (result) {
            let positions = result.positions
            for (let i = 0; i < positions.length - 1; ++i) {
              let geom = new Cesium.SectionPlaneGeometry({
                positions: [positions[i], positions[i + 1]],
                topHeight: 100,
                bottomHeight: 1200
              })
              // 设置只显示剖面,可以配合CuttingTool工具同时显示模型和剖面实现封边效果
              tileset.sectionOnly(true)
              // 向m3d图层设置剖面几何
              tileset.addSectionGeometry({ geometry: geom })
            }
            drawElement.stopDrawing()
          }
        })
      }

      // 添加横剖面
      function addHorizontalSection() {
        //先移除上次的切面
        removeSection()
        // 创建交互绘制工具
        drawElement = new zondy.cesium.DrawElement(viewer)
        drawElement.startDrawingPolyline({
          callback: function (result) {
            var positions = result.positions
            for (var i = 0; i < positions.length - 1; ++i) {
              var geom = new Cesium.SectionPlaneGeometry({
                positions: [positions[i], positions[i + 1]],
                // 设置topHeight和bottomHeight相同值，避免因向量方向导致正反面裁剪的深度不一致
                topHeight: 1200,
                bottomHeight: 1200,
                isHorizontal: true
              })
              // 设置只显示剖面,可以配合CuttingTool工具同时显示模型和剖面实现封边效果
              tileset.sectionOnly(true)
              // 向m3d图层设置剖面几何
              tileset.addSectionGeometry({ geometry: geom })
            }
            drawElement.stopDrawing()
          }
        })
      }

      function addHorizontalSectionByHeight() {
        // 先移除上次的切面
        removeSection()
        // 设置只显示剖面,可以配合CuttingTool工具同时显示模型和剖面实现封边效果
        tileset.sectionOnly(true)
        tileset.addSectionGeometry({
          geometry: Cesium.SectionPlaneGeometry.createPlaneGeometryByHeight(
            [tileset],
            tileset instanceof Cesium.MapGISM3DSet ? -500 : 0
          )
        })
      }

      function addHorizontalSectionByPositions() {
        // 先移除上次的切面
        removeSection()

        let positions
        if (tileset instanceof Cesium.MapGISM3DSet) {
          positions = [
            {
              x: -2560899.547952669,
              y: 4898389.417259944,
              z: 3170871.8996368214
            },
            {
              x: -2561130.42234208,
              y: 4898620.797173124,
              z: 3171051.5132434503
            },
            {
              x: -2560605.882524569,
              y: 4897812.988922655,
              z: 3171999.5037288275
            },
            {
              x: -2560836.7568747043,
              y: 4898044.36864775,
              z: 3172179.1172290794
            }
          ].map(function (position) {
            return new Cesium.Cartesian3(position.x, position.y, position.z)
          })
        } else if (tileset instanceof Cesium.Cesium3DTileset) {
          positions = [
            {
              x: -2177582.624103464,
              y: 4388565.279698851,
              z: 4070332.0485490714
            },
            {
              x: -2177646.52955818,
              y: 4389003.565761476,
              z: 4069828.6442444855
            },
            {
              x: -2177990.5951875453,
              y: 4388813.77192029,
              z: 4069849.0664698198
            },
            {
              x: -2177951.8860621825,
              y: 4388486.4965347415,
              z: 4070220.1751120593
            }
          ].map(function (position) {
            return new Cesium.Cartesian3(position.x, position.y, position.z)
          })
        }

        // 设置只显示剖面,可以配合CuttingTool工具同时显示模型和剖面实现封边效果
        tileset.sectionOnly(true)
        tileset.addSectionGeometry({
          geometry: Cesium.SectionPlaneGeometry.createPlaneGeometryByPositions(
            positions[0],
            positions[1],
            positions[2],
            positions[3]
          )
        })
      }

      // 移除剖面
      function removeSection() {
        // 移除剖面几何
        if (Cesium.defined(tileset)) {
          tileset.removeAllSectionGeometry()
        }

        // 停止绘制工具
        if (Cesium.defined(drawElement)) {
          drawElement.stopDrawing()
          drawElement = undefined
        }

        // 禁止点选
        viewer.screenSpaceEventHandler.removeInputAction(
          Cesium.ScreenSpaceEventType.LEFT_CLICK
        )
      }

      // 开启点选
      function enablePick() {
        // 监听鼠标点击事件,进行模型拾取高亮
        let highlightColor = new Cesium.Color(1.0, 1.0, 0.0, 0.6)
        let leftClickHandler1 = function onLeftClick(movement) {
          let oid = viewer.scene.pickOid(movement.position)
          tileset.pickedOid = oid
          tileset.pickedColor = highlightColor
        }

        // 获取属性值
        let leftClickHandler2 = function onLeftClick(movement) {
          const feature = viewer.scene.pick(movement.position)
          if (feature instanceof Cesium.Cesium3DTileFeature) {
            const propertyIds = feature.getPropertyIds()
            console.log('propertyIds', propertyIds)

            for (let i = 0; i < propertyIds.length; ++i) {
              const propertyId = propertyIds[i]
              console.log(`${propertyId}: ${feature.getProperty(propertyId)}`)
            }
          }
        }

        const currentCesiumVersion = localStorage.getItem(
          'currentCesiumVersion'
        )

        if (currentCesiumVersion === '10.7.2.10') {
          viewer.screenSpaceEventHandler.setInputAction(
            leftClickHandler1,
            Cesium.ScreenSpaceEventType.LEFT_CLICK
          )
        } else {
          viewer.screenSpaceEventHandler.setInputAction(
            leftClickHandler2,
            Cesium.ScreenSpaceEventType.LEFT_CLICK
          )
        }
      }

      function initUI() {
        pane = new Pane({
          title: '操作面板'
        })

        const modelCacheBladeFolder = pane.addFolder({
          title: '模型缓存类型'
        })

        const modelSectionFolder = pane.addFolder({
          title: '剖面操作选项'
        })

        const modelTypeList = modelCacheBladeFolder
          .addBlade({
            view: 'list',
            label: '切换类型',
            options: [
              {
                text: 'MapGIS M3D',
                value: 'M3D'
              },
              {
                text: 'Cesium 3D Tiles',
                value: '3DTILES'
              }
            ],
            value: 'M3D'
          })
          .on('change', (e) => {
            if (e.value === 'M3D') {
              cesium3DTilesModelList.hidden = true
              M3DModelList.hidden = false
              loadTileset(DEFAULT_URL.MAPGIS_M3D_21, 'M3D')
            } else if (e.value === '3DTILES') {
              cesium3DTilesModelList.hidden = false
              M3DModelList.hidden = true
              loadTileset(DEFAULT_URL.CESIUM_3DTILES_10, '3DTILES')
            }
          })

        const M3DModelList = modelCacheBladeFolder
          .addBlade({
            view: 'list',
            label: 'M3D',
            options: [
              {
                text: '地质体-M3D 2.1-文件服务',
                value: DEFAULT_URL.MAPGIS_M3D_21
              }
            ],
            value: DEFAULT_URL.MAPGIS_M3D_21
          })
          .on('change', (e) => {})

        const cesium3DTilesModelList = modelCacheBladeFolder
          .addBlade({
            hidden: true,
            view: 'list',
            label: '3D Tiles',
            options: [
              {
                text: '地质体-3D Tiles 1.0-文件服务',
                value: DEFAULT_URL.CESIUM_3DTILES_10
              }
            ],
            value: DEFAULT_URL.CESIUM_3DTILES_10
          })
          .on('change', (e) => {})

        modelSectionFolder
          .addButton({
            title: '添加竖面'
          })
          .on('click', () => {
            addVerticalSection()
          })

        modelSectionFolder
          .addButton({
            title: '添加横面'
          })
          .on('click', () => {
            addHorizontalSection()
          })

        modelSectionFolder
          .addButton({
            title: '添加横面（统一高度）'
          })
          .on('click', () => {
            addHorizontalSectionByHeight()
          })

        modelSectionFolder
          .addButton({
            title: '添加横面（控制点）'
          })
          .on('click', () => {
            addHorizontalSectionByPositions()
          })

        modelSectionFolder
          .addButton({
            title: '开启点选'
          })
          .on('click', () => {
            enablePick()
          })

        pane
          .addButton({
            title: '移除剖面 '
          })
          .on('click', () => {
            removeSection()
          })
      }

      // 地图初始化函数
      function init() {
        // 初始化球体
        initViewer()
        // 加载模型
        loadTileset(DEFAULT_URL.MAPGIS_M3D_21, 'M3D')
        // 初始化UI
        initUI()
      }

      init()
    </script>
    <style>
      #mapgis-3d-viewer {
        position: absolute;
        left: 0;
        top: 0;
      }
    </style>
  </body>
</html>
