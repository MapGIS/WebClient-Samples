<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>地质体夸张显示</title>
    <!--加载不同版本Cesium库-->
    <script src="http://10.10.130.72:8086/static/libs/loadCesium.js"></script>
    <!--plugin脚本库-->
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-common.min.js"></script>
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-cesium-plugin.min.js"></script>
    <!--示例公共样式-->
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/css/style.css"
    />
  </head>

  <body>
    <div id="mapgis-3d-viewer"></div>
    <div id="app-tips">
      提示：10.7.2.10版本不支持3D Tiles模型拉伸夸张显示功能
    </div>

    <script type="module">
      'use strict'
      import { Pane } from 'http://10.10.130.72:8086/static/libs/cdn/tweakpane/tweakpane.min.js'

      // 定义三维视图的主要类
      let map, sceneView, viewer, tileset, pane

      // 定义默认的模型URL
      const DEFAULT_URL = {
        MAPGIS_M3D_21:
          'http://10.10.130.72:8200/3DData/ModelCache/M3D/2.1/wujiangdizhiti_21/wujiangdizhiti_21.mcj',
        CESIUM_3DTILES_10:
          'http://10.10.130.72:8200/3DData/ModelCache/3DTileset/1.0/wujiangdizhiti/tileset.json'
      }

      let currentCesiumVersion = localStorage.getItem('currentCesiumVersion')

      // 初始化球体
      function initViewer() {
        // 初始化图层管理容器
        map = new zondy.Map()
        // 初始化地图视图对象
        sceneView = new zondy.cesium.SceneView({
          // 视图id
          viewId: 'mapgis-3d-viewer',
          // 图层管理容器
          map: map
        })
        // 获取视图对象
        viewer = sceneView.getInnerView()
        viewer.scene.skyBox.show = false
        viewer.scene.skyAtmosphere.show = false
        viewer.scene.sun.show = false
        viewer.scene.moon.show = false
        viewer.scene.globe.showGroundAtmosphere = false
        viewer.scene.globe.show = false
      }

      async function loadTileset(url, type) {
        viewer.scene.primitives.remove(tileset)
        if (type === 'M3D') {
          tileset = await zondy.cesium.MapGISM3DSet.fromUrl(url, {
            _scene: viewer.scene
          })
        } else if (type === '3DTILES') {
          tileset = await zondy.cesium.Cesium3DTileset.fromUrl(url)
        }
        viewer.scene.primitives.add(tileset)
        viewer.zoomTo(
          tileset,
          new Cesium.HeadingPitchRange(0, -Math.PI / 4, 3000)
        )
        // 开启模型拉伸
        tileset.enableStretch = true
        // 模型拉伸参考高度
        tileset.stretchReferenceHeight = 0
        // 模型拉伸系数
        tileset.stretchFactor = 1
      }

      // 初始化示例UI操作
      function initUI() {
        pane = new Pane({
          title: '操作面板'
        })

        const controls = {
          enableStretch: true,
          stretchReferenceHeight: 0,
          stretchFactor: 1
        }

        const modelCacheBladeFolder = pane.addFolder({
          title: '模型缓存类型'
        })

        const modelStretchOptionsFolder = pane.addFolder({
          title: '模型拉伸选项'
        })

        function resetComponents() {
          controls.enableStretch = true
          controls.stretchReferenceHeight = 0
          controls.stretchFactor = 1
        }

        const modelTypeList = modelCacheBladeFolder
          .addBlade({
            view: 'list',
            label: '切换类型',
            options: [
              {
                text: 'MapGIS M3D',
                value: 'M3D'
              },
              {
                text: 'Cesium 3D Tiles',
                value: '3DTILES'
              }
            ],
            value: 'M3D'
          })
          .on('change', (e) => {
            if (e.value === 'M3D') {
              cesium3DTilesModelList.hidden = true
              M3DModelList.hidden = false
              loadTileset(DEFAULT_URL.MAPGIS_M3D_21, 'M3D')
            } else if (e.value === '3DTILES') {
              cesium3DTilesModelList.hidden = false
              M3DModelList.hidden = true
              loadTileset(DEFAULT_URL.CESIUM_3DTILES_10, '3DTILES')
            }
            resetComponents()
          })

        if (currentCesiumVersion === '10.7.2.10') {
          modelTypeList.disabled = true
        }

        const M3DModelList = modelCacheBladeFolder
          .addBlade({
            view: 'list',
            label: 'M3D',
            options: [
              {
                text: '地质体-M3D 2.1-文件服务',
                value: DEFAULT_URL.MAPGIS_M3D_21
              }
            ],
            value: DEFAULT_URL.MAPGIS_M3D_21
          })
          .on('change', (e) => {})

        const cesium3DTilesModelList = modelCacheBladeFolder
          .addBlade({
            hidden: true,
            view: 'list',
            label: '3D Tiles',
            options: [
              {
                text: '地质体-3D Tiles 1.0-文件服务',
                value: DEFAULT_URL.CESIUM_3DTILES_10
              }
            ],
            value: DEFAULT_URL.CESIUM_3DTILES_10
          })
          .on('change', (e) => {})

        modelStretchOptionsFolder
          .addBinding(controls, 'enableStretch', {
            label: '模型拉伸'
          })
          .on('change', (e) => {
            tileset.enableStretch = e.value
          })

        modelStretchOptionsFolder
          .addBinding(controls, 'stretchReferenceHeight', {
            label: '参考高度',
            min: -500,
            max: 500
          })
          .on('change', (e) => {
            tileset.stretchReferenceHeight = e.value
          })

        modelStretchOptionsFolder
          .addBinding(controls, 'stretchFactor', {
            label: '拉伸系数',
            min: 1,
            max: 10
          })
          .on('change', (e) => {
            tileset.stretchFactor = e.value
          })

        pane
          .addButton({
            title: '重置'
          })
          .on('click', () => {
            controls.stretchReferenceHeight = 0
            controls.stretchFactor = 1
            tileset.stretchReferenceHeight = 0
            tileset.stretchFactor = 1
            pane.refresh()
          })
      }

      // 地图初始化函数
      function init() {
        // 初始化球体
        initViewer()
        // 创建切换Cesium版本的按钮
        createChangeTab()
        // 加载默认的3D模型-MAPGIS_M3D_21
        loadTileset(DEFAULT_URL.MAPGIS_M3D_21, 'M3D')
        // 初始化示例UI操作
        initUI()
      }

      init()
    </script>

    <style>
      #mapgis-3d-viewer {
        position: absolute;
        left: 0;
        top: 0;
      }
      #app-tips {
        position: absolute;
        top: 10px;
        left: 10px;
        background: #28292e;
        color: #f5f5f5;
        padding: 5px;
        user-select: none;
        font-size: 12px;
        border-radius: 2px;
      }
    </style>
  </body>
</html>
