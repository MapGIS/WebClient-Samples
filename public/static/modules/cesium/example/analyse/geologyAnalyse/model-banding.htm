<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>地质体封边工具</title>
    <!--加载不同版本Cesium库-->
    <script src="http://10.10.130.72:8086/static/libs/loadCesium.js"></script>
    <!--plugin脚本库-->
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-common.min.js"></script>
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-cesium-plugin.min.js"></script>
    <script src="http://10.10.130.72:8086/static/assets/js/TDT-token.js"></script>
    <!--示例公共样式-->
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/css/style.css"
    />
  </head>

  <body>
    <div id="mapgis-3d-viewer"></div>
    <div id="app-tips">
      提示：10.7.2.10暂不支持3D Tiles剖面封边，10.7.4.10暂不支持3D
      Tiles封边属性过滤
    </div>

    <script type="module">
      'use strict'
      import { Pane } from 'http://10.10.130.72:8086/static/libs/cdn/tweakpane/tweakpane.min.js'

      // 定义创建图层与UI交互相关的变量
      let map, sceneView, viewer, cutTool, drawElement, pane, layer

      // 该方法用于初始化三维地图查看器，包括创建图层管理容器，初始化地图视图对象以及获取Cesium场景视图对象
      function initViewer() {
        map = new zondy.Map()
        sceneView = new zondy.cesium.SceneView({
          viewId: 'mapgis-3d-viewer',
          map: map
        })
        viewer = sceneView.getInnerView()

        // 去除场景中的其他要素
        viewer.scene.skyBox.show = false
        viewer.scene.skyAtmosphere.show = false
        viewer.scene.sun.show = false
        viewer.scene.moon.show = false
        viewer.scene.globe.showGroundAtmosphere = false
        viewer.scene.globe.show = false

        // 创建绘制工具
        // 参考API: http://10.10.130.72:8086/static/modules/cesium/api/cesium-mapgis/DrawElement.html
        drawElement = new zondy.cesium.DrawElement(viewer)
      }

      /**
       * 该方法用于添加模型缓存图层，根据模型缓存类型创建对应的模型缓存图层对象
       * @param {string} url - 模型缓存文件的URL地址
       * @param {string} modelType - 模型缓存类型，可选值为'M3D'或'3DTILES'
       */
      function addModelCacheLayer(url, modelType) {
        const lastLayer = layer
        let modelCacheLayer = undefined

        if (modelType === 'M3D') {
          modelCacheLayer = new zondy.layer.M3DModelCacheLayer({
            url,
            extensionOptions: {
              autoReset: true,
              fillClip: true // 开启剖面封边
            }
          })
        } else if (modelType === '3DTILES') {
          modelCacheLayer = new zondy.layer.Cesium3DTilesCacheLayer({
            url,
            extensionOptions: {
              autoReset: true,
              fillClip: true // 开启剖面封边
            }
          })
        }

        if (modelCacheLayer) {
          map.add(modelCacheLayer)
          // 图层加载完毕的回调方法
          modelCacheLayer.on('layerview-created', function (result) {
            // 获取内部图层对象，即MapGISM3DSet或Cesium3DTileset对象
            layer = sceneView.getInnerLayer(result.layer)
            // 在添加模型缓存图层后，要移除之前的模型缓存图层
            if (viewer.scene.primitives.contains(lastLayer)) {
              viewer.scene.primitives.remove(lastLayer)
            }
            removeCuttingPlane()
            // 参考API: http://10.10.130.72:8086/static/modules/cesium/api/cesium-mapgis/CuttingTool.html
            cutTool = new zondy.cesium.CuttingTool(viewer, [layer])
          })
        }
      }

      // 该方法用于绘制剖切面
      function addClippingPlane() {
        removeCuttingPlane()
        drawElement.startDrawingPolyline({
          callback: function (result) {
            let positions = result.positions
            let lines = []
            for (let i = 0; i < positions.length; i++) {
              let tempPoint = Cesium.Cartographic.fromCartesian(positions[i])
              lines.push(
                new Cesium.Cartesian3(
                  Cesium.Math.toDegrees(tempPoint.longitude),
                  Cesium.Math.toDegrees(tempPoint.latitude),
                  tempPoint.height
                )
              )
            }
            cutTool.createModelCuttingPlaneFromPolyline(lines, {
              unionClippingRegions: false,
              showCuttingPlane: false
            })
            drawElement.stopDrawing()
          }
        })
      }

      // 该方法用于更新裁剪面距离
      function updateCuttingPlaneDistance(value) {
        if (layer && layer.clippingPlanes) {
          let planes = layer.clippingPlanes
          if (planes && layer.clippingPlanes.get(0)) {
            for (let i = 0; i < planes.length; i++) {
              layer.clippingPlanes.get(i).distance = value
            }
          }
        }
      }

      // 该方法用于绘制裁剪体
      function addClippingPolygon() {
        removeCuttingPlane()
        drawElement.startDrawingPolygon({
          callback: function (result) {
            let positions = result.positions
            let pnts = []
            for (let i = 0; i < positions.length; i++) {
              let position = positions[i]
              let c1 = Cesium.Cartographic.fromCartesian(position)
              let p1 = new Cesium.Cartesian3(
                Cesium.Math.toDegrees(c1.longitude),
                Cesium.Math.toDegrees(c1.latitude),
                c1.height
              )
              pnts.push(p1)
            }
            cutTool.createModelCuttingVolume(pnts, -3000, 3000, {
              unionClippingRegions: true,
              distance: 0,
              showCuttingPlane: false
            })
            drawElement.stopDrawing()
          }
        })
      }

      // 该方法用于移除所有剖切面
      function removeCuttingPlane() {
        if (layer && layer.clippingPlanes) {
          layer.clippingPlanes.removeAll()
        }
        if (drawElement) {
          drawElement.stopDrawing()
        }
      }

      // 该方法用于设置剖切封边属性过滤类型
      function applyClippingFilter(clippingFilterType) {
        let cuttingFilter = []
        if (clippingFilterType === 'EMPTY') {
          // 无过滤
          layer.cuttingFilter = []
        } else if (clippingFilterType === 'SINGLE_VALUE') {
          // 单值过滤
          if (layer.version === '2.0') {
            cuttingFilter = [
              {
                field: 'OID',
                type: 'unique',
                valueGroups: [1, 2, 3, 4, 5]
              }
            ]
          } else if (layer.version === '2.1') {
            cuttingFilter = [
              {
                field: 'tid',
                type: 'unique',
                valueGroups: [0, 1, 2, 3, 4]
              }
            ]
          }
        } else if (clippingFilterType === 'CLASS_BREAK') {
          // 分段过滤
          if (layer.version === '2.0') {
            cuttingFilter = [
              {
                field: 'OID',
                type: 'range',
                valueGroups: [
                  { start: 1, end: 4 },
                  { start: 6, end: 7 }
                ]
              }
            ]
          } else if (layer.version === '2.1') {
            cuttingFilter = [
              {
                field: 'tid',
                type: 'range',
                valueGroups: [
                  { start: 1, end: 2 },
                  { start: 5, end: 7 }
                ]
              }
            ]
          }
        } else if (clippingFilterType === 'CONTAIN') {
          // 包含过滤
          if (layer.version === '2.0') {
            cuttingFilter = [
              {
                field: 'FeaName',
                type: 'contain',
                valueGroups: ['object']
              }
            ]
          } else if (layer.version === '2.1') {
            cuttingFilter = [
              {
                field: 'LayerName',
                type: 'contain',
                valueGroups: ['BottomFace']
              }
            ]
          }
        }
        layer.cuttingFilter = cuttingFilter
      }

      // 该方法用于初始化UI操作面板
      function initUI() {
        pane = new Pane({
          title: '操作面板'
        })
        const modelCacheBladeFolder = pane.addFolder({
          title: '模型缓存类型'
        })
        const clippingAttributesFilterFolder = pane.addFolder({
          title: '剖切封边属性过滤'
        })
        const clippingPlaneFolder = pane.addFolder({
          title: '封边剖切面'
        })
        const clippingVolumeFolder = pane.addFolder({
          title: '封边剖切体'
        })

        // 定义默认参数
        const paneParameters = {
          clippingDistance: 0,
          enableClippingAttributesFilter: false
        }

        // 该控件允许用户在MapGIS M3D和Cesium 3D Tiles两种模型类型之间切换
        const modelTypeList = modelCacheBladeFolder
          .addBlade({
            view: 'list',
            label: '切换类型',
            options: [
              {
                text: 'MapGIS M3D',
                value: 'M3D'
              },
              {
                text: 'Cesium 3D Tiles',
                value: '3DTILES'
              }
            ],
            value: 'M3D'
          })
          .on('change', (e) => {
            // 根据选择的模型类型切换显示对应的模型列表并加载模型数据
            if (e.value === 'M3D') {
              cesium3DTilesModelList.hidden = true
              M3DModelList.hidden = false
              addModelCacheLayer(
                'http://10.10.130.72:8200/3DData/ModelCache/M3D/2.0/wujiangdizhiti/wujiangdizhiti.mcj',
                'M3D'
              )
            } else if (e.value === '3DTILES') {
              cesium3DTilesModelList.hidden = false
              M3DModelList.hidden = true
              addModelCacheLayer(
                'http://10.10.130.72:8200/3DData/ModelCache/3DTileset/1.0/wujiangdizhiti/tileset.json',
                '3DTILES'
              )
            }
            resetComponents()
          })

        // 定义MapGIS M3D的模型缓存列表
        const M3DModelList = modelCacheBladeFolder
          .addBlade({
            view: 'list',
            label: 'M3D',
            options: [
              {
                text: '地质体-M3D 2.0-文件服务',
                value:
                  'http://10.10.130.72:8200/3DData/ModelCache/M3D/2.0/wujiangdizhiti/wujiangdizhiti.mcj'
              },
              {
                text: '地质体-M3D 2.0-M3DServer',
                value:
                  'http://10.10.130.72:8089/igs/rest/services/M3Dv2/地质体封边模型/M3dServer'
              }
            ],
            value:
              'http://10.10.130.72:8200/3DData/ModelCache/M3D/2.0/wujiangdizhiti/wujiangdizhiti.mcj'
          })
          .on('change', (e) => {
            addModelCacheLayer(e.value, 'M3D')
            resetComponents()
          })

        // 定义Cesium 3D Tiles的模型缓存列表
        const cesium3DTilesModelList = modelCacheBladeFolder
          .addBlade({
            hidden: true,
            view: 'list',
            label: '3D Tiles',
            options: [
              {
                text: '地质体-3D Tiles 1.0-文件服务',
                value:
                  'http://10.10.130.72:8200/3DData/ModelCache/3DTileset/1.0/wujiangdizhiti/tileset.json'
              },
              {
                text: '地质体-3D Tiles 1.1-文件服务',
                value:
                  'http://10.10.130.72:8200/3DData/ModelCache/3DTileset/1.1/wujiangdizhiti/tileset.json'
              }
            ],
            value:
              'http://10.10.130.72:8200/3DData/ModelCache/3DTileset/1.0/wujiangdizhiti/tileset.json'
          })
          .on('change', (e) => {
            addModelCacheLayer(e.value, '3DTILES')
            resetComponents()
          })

        clippingPlaneFolder
          .addButton({
            title: '绘制剖切面'
          })
          .on('click', () => {
            addClippingPlane()
            attributesFilterChecker.disabled = true
            attributesFilterBlade.disabled = true
            clippingDistanceSlider.disabled = false
          })

        const clippingDistanceSlider = clippingPlaneFolder
          .addBinding(paneParameters, 'clippingDistance', {
            disabled: true,
            label: '切面位置',
            min: -400,
            max: 400
          })
          .on('change', (e) => {
            updateCuttingPlaneDistance(e.value)
          })

        clippingVolumeFolder
          .addButton({
            title: '绘制剖切体'
          })
          .on('click', () => {
            addClippingPolygon()
            attributesFilterChecker.disabled = true
            attributesFilterBlade.disabled = true
          })

        const attributesFilterChecker = clippingAttributesFilterFolder
          .addBinding(paneParameters, 'enableClippingAttributesFilter', {
            label: '属性过滤'
          })
          .on('change', (e) => {
            layer.enableCuttingFilter = e.value
          })

        // 定义属性过滤的类型
        const attributesFilterBlade = clippingAttributesFilterFolder
          .addBlade({
            view: 'list',
            label: '过滤方式',
            options: [
              {
                text: '无过滤',
                value: 'EMPTY'
              },
              {
                text: '单值',
                value: 'SINGLE_VALUE'
              },
              {
                text: '分段',
                value: 'CLASS_BREAK'
              },
              {
                text: '包含',
                value: 'CONTAIN'
              }
            ],
            value: 'EMPTY'
          })
          .on('change', (e) => {
            applyClippingFilter(e.value)
          })

        pane
          .addButton({
            title: '清除所有剖切面'
          })
          .on('click', () => {
            removeCuttingPlane()
            resetComponents()
          })

        // 该方法用于重置UI组件
        function resetComponents() {
          attributesFilterChecker.disabled = false
          attributesFilterBlade.disabled = false
          clippingDistanceSlider.disabled = true
          paneParameters.clippingDistance = 0
          paneParameters.enableClippingAttributesFilter = false
          attributesFilterBlade.value = 'EMPTY'
          pane.refresh()
        }
      }

      // 该方法用于初始化整个应用，包括初始化查看器、添加模型缓存图层和初始化用户界面
      function init() {
        initViewer()
        createChangeTab()
        addModelCacheLayer(
          'http://10.10.130.72:8200/3DData/ModelCache/M3D/2.0/wujiangdizhiti/wujiangdizhiti.mcj',
          'M3D'
        )
        initUI()
      }

      init()
    </script>

    <style>
      #mapgis-3d-viewer {
        position: absolute;
        left: 0;
        top: 0;
      }
      /* 提示内容样式 */
      #app-tips {
        position: absolute;
        top: 10px;
        left: 10px;
        /* left: 50%; */
        /* transform: translateX(-50%); */
        background: #28292e;
        color: #f5f5f5;
        padding: 5px;
        user-select: none;
        font-size: 12px;
        border-radius: 2px;
      }
    </style>
  </body>
</html>
