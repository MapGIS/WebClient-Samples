<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>体积云</title>
    <!--加载Cesium库-->
    <script src="http://10.10.130.72:8086/static/libs/cdn/cesium/Cesium.js"></script>
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/cdn/cesium/Widgets/widgets.css"
    />
    <!--plugin脚本库-->
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-common.min.js"></script>
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-cesium-plugin.min.js"></script>
    <script src="http://10.10.130.72:8086/static/assets/js/TDT-token.js"></script>
    <!--示例公共样式-->
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/css/style.css"
    />
  </head>

  <body>
    <div id="mapgis-3d-viewer"></div>
    <script type="module">
      'use strict'
      import { Pane } from 'http://10.10.130.72:8086/static/libs/cdn/tweakpane/tweakpane.min.js'

      // 定义视图等变量
      let map, sceneView, viewer, pane, volumeCloud, volumeCloudControls
      const defaultVolumeCloudControls = {
        // 体积云效果
        show: true,
        density: 0.27,
        minHeight: 7500,
        maxHeight: 8000,
        speed: 0.1,
        direction: 90
      }
      async function init() {
        initViewer()
        addTDT()
        initVolumeCloud()
        initUI()
      }
      init()

      function throttle(fn, delay = 200) {
        let last = 0
        return function () {
          let now = Date.now()
          if (now - last > delay) {
            last = now
            fn.apply(this, arguments)
          }
        }
      }
      // 初始场景
      function initViewer() {
        map = new zondy.Map()
        sceneView = new zondy.cesium.SceneView({
          viewId: 'mapgis-3d-viewer',
          map: map,
          extensionOptions: {
            timeline: true
          }
        })
        viewer = sceneView.getInnerView()

        sceneView.on('loaded', () => {
          viewer.camera.setView({
            destination: {
              x: -2272186.6444962607,
              y: 5032207.953978554,
              z: 3182874.755872283
            },
            orientation: {
              heading: 0.06266785592645174,
              pitch: 0.16549326305365764,
              roll: 6.282848966277779
            }
          })
        })

        // viewer.scene.debugShowFramesPerSecond = true
      }
      // 添加天地图
      async function addTDT() {
        let TDTLayer = new zondy.layer.WMTSLayer({
          // 加载经纬度的影像地图
          url: 'http://t6.tianditu.gov.cn/img_c/wmts',
          // 天地图必须加token，且token名为tk
          tokenKey: 'tk',
          // token请在天地图官网申请
          tokenValue: getTDTToken()
        })
        map.add(TDTLayer)
      }
      function initVolumeCloud() {
        let rectangle = Cesium.Rectangle.fromDegrees(-180, -90, 180, 90)
        volumeCloud = new zondy.cesium.VolumeCloud(
          Object.assign({ viewer, rectangle }, defaultVolumeCloudControls)
        )
      }

      // 初始化UI组件
      function initUI() {
        if (pane) {
          pane.dispose()
        }
        pane = new Pane({
          title: '体积云特效操作面板'
        })

        const volumeCloudFolder = pane.addFolder({
          title: '体积云控制'
        })

        volumeCloudControls = Object.assign({}, defaultVolumeCloudControls)

        // 体积云控制
        volumeCloudFolder
          .addBinding(volumeCloudControls, 'show', {
            label: '显示体积云'
          })
          .on('change', (e) => {
            volumeCloud.show = e.value
          })

        volumeCloudFolder
          .addBinding(volumeCloudControls, 'density', {
            label: '云层密度',
            min: 0,
            max: 1
          })
          .on('change', (e) => {
            volumeCloud.density = e.value
          })

        // 高度调整会带来体积云几何体重构，带来性能消耗，应尽量避免高频率更新，使用节流函数封装处理
        let updateMinHeight = throttle(() => {
          volumeCloud.minHeight = volumeCloudControls.minHeight
        }, 500)
        let updateMaxHeight = throttle(() => {
          volumeCloud.maxHeight = volumeCloudControls.maxHeight
        }, 500)

        volumeCloudFolder
          .addBinding(volumeCloudControls, 'minHeight', {
            label: '云层最低高度',
            min: 0,
            max: 20000
          })
          .on('change', (e) => {
            if (e.value >= volumeCloudControls.maxHeight) {
              volumeCloudControls.minHeight = volumeCloudControls.maxHeight - 1
              updateMinHeight()
              pane.refresh()
            } else {
              updateMinHeight()
            }
          })

        volumeCloudFolder
          .addBinding(volumeCloudControls, 'maxHeight', {
            label: '云层最高高度',
            min: 0,
            max: 20000
          })
          .on('change', (e) => {
            if (e.value <= volumeCloudControls.minHeight) {
              volumeCloudControls.maxHeight = volumeCloudControls.minHeight + 1
              updateMaxHeight()
              pane.refresh()
            } else {
              updateMaxHeight()
            }
          })

        volumeCloudFolder
          .addBinding(volumeCloudControls, 'speed', {
            label: '速度',
            min: 0,
            max: 1
          })
          .on('change', (e) => {
            volumeCloud.speed = e.value
          })

        volumeCloudFolder
          .addBinding(volumeCloudControls, 'direction', {
            label: '方向',
            min: 0,
            max: 360
          })
          .on('change', (e) => {
            volumeCloud.direction = e.value
          })
        volumeCloudFolder
          .addButton({
            title: '重置'
          })
          .on('click', () => {
            volumeCloud.destroy()
            initVolumeCloud()
            initUI()
          })
      }
    </script>

    <style>
      /* tweakpane样式 */
      .tp-dfwv {
        position: absolute;
        top: 15px;
        /* left: 10px; */
        width: 240px;
      }
    </style>
  </body>
</html>
