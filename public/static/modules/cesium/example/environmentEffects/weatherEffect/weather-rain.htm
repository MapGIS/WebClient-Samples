<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>雨天气</title>
    <!--加载不同版本Cesium库-->
    <script src="http://10.10.130.72:8086/static/libs/loadCesium.js"></script>
    <!--plugin脚本库-->
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-common.min.js"></script>
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-cesium-plugin.min.js"></script>
    <script src="http://10.10.130.72:8086/static/assets/js/TDT-token.js"></script>
    <!--示例公共样式-->
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/css/style.css"
    />
  </head>

  <body>
    <div id="mapgis-3d-viewer"></div>
    <script type="module">
      'use strict'
      import { Pane } from 'http://10.10.130.72:8086/static/libs/cdn/tweakpane/tweakpane.min.js'

      // 定义创建图层与UI交互相关的变量
      let map, sceneView, viewer, pane, rain

      // 该方法用于初始化三维地图查看器，包括创建图层管理容器，初始化地图视图对象以及获取Cesium场景视图对象
      function initViewer() {
        map = new zondy.Map()
        sceneView = new zondy.cesium.SceneView({
          viewId: 'mapgis-3d-viewer',
          map: map
        })
        viewer = sceneView.getInnerView()
        // 开启地形深度测试
        viewer.scene.globe.depthTestAgainstTerrain = true
      }

      // 该方法用于添加M3D模型缓存图层
      function addModelCacheLayer() {
        const modelCacheLayer = new zondy.layer.M3DModelCacheLayer({
          url: 'http://10.10.130.72:8200/3DData/ModelCache/M3D//1.0/ZondyFaceModels/ZondyFaceModels.mcj',
          extensionOptions: {
            // 开启自动跳转
            autoReset: true
          }
        })
        map.add(modelCacheLayer)
      }

      // 该方法用于加载天地图
      function addTDT() {
        let TDTLayer = new zondy.layer.WMTSLayer({
          // 加载经纬度的影像地图
          url: 'http://t6.tianditu.gov.cn/img_c/wmts',
          // 天地图必须加token，且token名为tk
          tokenKey: 'tk',
          // token请在天地图官网申请
          tokenValue: getTDTToken()
        })
        map.add(TDTLayer)
      }

      // 该方法用于添加场景雨后处理特效
      function addRain() {
        rain = viewer.scene.postProcessStages.add(
          zondy.cesium.PostProcessStageLibrary.createRainStage({ viewer })
        )
      }

      // 该方法用于初始化UI操作面板
      function initUI() {
        pane = new Pane({
          title: '操作面板'
        })

        // 定义默认参数
        const paneParameters = {
          enabled: true,
          alpha: 0.3,
          angle: 0,
          speed: 15,
          rainLength: 0,
          factor: 0.1,
          intensity: 1.0,
        }

        pane
          .addBinding(paneParameters, 'enabled', {
            label: '开启降雨'
          })
          .on('change', (e) => {
            rain.enabled = e.value
          })

        pane
          .addBinding(paneParameters, 'alpha', {
            label: '透明度',
            min: 0,
            max: 1
          })
          .on('change', (e) => {
            rain.uniforms.alpha = e.value
          })

        pane
          .addBinding(paneParameters, 'angle', {
            label: '倾斜角度',
            min: -45,
            max: 45
          })
          .on('change', (e) => {
            rain.uniforms.angle = e.value
          })

        pane
          .addBinding(paneParameters, 'speed', {
            label: '速度',
            min: 1,
            max: 20
          })
          .on('change', (e) => {
            rain.uniforms.speed = e.value
          })

        pane
          .addBinding(paneParameters, 'rainLength', {
            label: '雨滴拖尾长度',
            min: 0,
            max: 10
          })
          .on('change', (e) => {
            rain.uniforms.rainLength = e.value
          })

        pane
          .addBinding(paneParameters, 'factor', {
            label: '场景混合度',
            min: 0,
            max: 1
          })
          .on('change', (e) => {
            rain.uniforms.factor = e.value
          })
          
        pane
          .addBinding(paneParameters, 'intensity', {
            label: '强度',
            min: 0,
            max: 1
          })
          .on('change', (e) => {
            rain.uniforms.intensity = e.value
          })

        pane
          .addButton({
            title: '重置'
          })
          .on('click', () => {
            paneParameters.enabled = true
            paneParameters.alpha = 0.3
            paneParameters.angle = 0
            paneParameters.speed = 15
            paneParameters.rainLength = 0
            paneParameters.factor = 0.1
            paneParameters.intensity = 1.0
            rain.enabled = true
            rain.uniforms.alpha = 0.3
            rain.uniforms.angle = 0
            rain.uniforms.speed = 15
            rain.uniforms.rainLength = 0
            rain.uniforms.factor = 0.1
            rain.uniforms.intensity = 1.0
            pane.refresh()
          })
      }

      // 该方法用于初始化整个应用，包括初始化查看器、添加模型缓存图层和初始化用户界面
      function init() {
        initViewer()
        createChangeTab()
        addModelCacheLayer()
        addRain()
        addTDT()
        initUI()
      }

      init()
    </script>

    <style>
      #mapgis-3d-viewer {
        position: absolute;
        left: 0;
        top: 0;
      }
    </style>
  </body>
</html>
