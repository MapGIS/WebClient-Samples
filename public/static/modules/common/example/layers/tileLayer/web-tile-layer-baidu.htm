<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>网络瓦片图层-百度栅格瓦片地图</title>
  <!-- 引入地图引擎库 -->
    <script
      src="http://webclient.smaryun.com/static/libs/include-lib-local-upgrade.js"
    ></script>
  <!--示例中面板、按钮等，第三方layui的js库与css样式-->
  <script src="http://webclient.smaryun.com/static/libs/cdn/layui/layui.js"></script>
    <link
      rel="stylesheet"
      href="http://webclient.smaryun.com/static/libs/cdn/layui/css/layui.css"
    />
  <!--示例公共样式-->
    <link
      rel="stylesheet"
      href="http://webclient.smaryun.com/static/libs/css/style.css"
    />
  <script src="http://webclient.smaryun.com/static/assets/js/TDT-token.js"></script>
    
  <script type="text/javascript">
    //使用严格模式
    'use strict'
    // 定义二维视图的主要类

    let map,
      view,
      BDLayer,
      GDLayer,
      TDTLayer,
      topLayer,
      layerOpacity = 1
    const {
      WebTileLayer,
      TileInfo
    } = zondy.layer
    const {
      Map,
      SpatialReference
    } = zondy
    const {
      Point,
      Extent,
      Polygon
    } = zondy.geometry

    // 初始化地图
    function init() {
      // 初始化地图视图
      initView()
      // 初始化示例UI
      initUI()
      // 添加百度图层
      addBDUnbiasedLayer()
      // addTDTLayer()
    }

    // 初始二维地图
    function initView() {
      // 初始化图层管理容器
      map = new Map()
      // 初始化地图视图对象
      view = createView('mapgis-viewer', map, {
        center: new zondy.geometry.Point({
          coordinates: [116.391305,39.90553]
        }),
        zoom:12,
        spatialReference: new SpatialReference({wkid:3857})
      })
      
    }

    // 添加无偏显示的百度地图
    function addBDUnbiasedLayer() {
      if (!BDLayer) {
        const spatialReference = new SpatialReference({
          wkid: zondy.enum.CustomWKID.bd09mc
        })

        // 构建tileInfo
        const maxLevel = 19
        const dpi = 96
        const lods = []
        for (let i = 0; i < maxLevel; i++) {
          lods.push({
            level: i,
            resolution: Math.pow(2, 18 - i),
            scale: (Math.pow(2, 18 - i) * dpi) / 0.0254
          })
        }
        BDLayer = new WebTileLayer({
          // 加载经纬度的影像地图。目前
          url: 'http://api{s}.map.bdimg.com/customimage/tile?&udt=20180601&scale=1&x={x}&y={y}&z={z}&styles=midnight',
          // 开启tms
          tileSliceType: 'tms',
          // 子域名。需要在url中增加{s}模板才能生效
          subDomains: ['1', '2'],
          // 指定坐标系
          spatialReference: spatialReference,
          // 网格划分信息
          tileInfo: new TileInfo({
            origin: {
              type: 'Point',
              coordinates: [0, 0],
              spatialReference: spatialReference
            },
            dpi: dpi,
            lods: lods,
            size: [256, 256],
            spatialReference: spatialReference
          }),
          // 数据范围
          extent: new Extent({
            xmin: 0,
            ymin: 0,
            xmax: 20037508.342789244,
            ymax: 20037508.342789244,
            spatialReference: spatialReference
          })
        })
        // 添加图层
        map.add(BDLayer)
      }
    }

    // 添加无偏显示的高德底图天地图
    function addGDUnbiasedLayer(){
      if (!GDLayer) {
          GDLayer = new WebTileLayer({
          url:"http://webst04.is.autonavi.com/appmaptile?=&size=1&scale=1&x={x}&y={y}&z={z}&style=7",
          spatialReference: new SpatialReference({ wkid: CustomWKID.gcj02mc }),
        })
        map.add(GDLayer)
        topLayer = GDLayer
      }
    }

    // 添加天地图
    function addTDTLayer() {
      // 创建瓦片图层
      TDTLayer = new WebTileLayer({
        // 加载经纬度的影像地图
        url: 'http://t1.tianditu.com/DataServer?T=vec_w&x={col}&y={row}&l={level}',
        // 天地图必须加token，且token名为tk
        tokenKey: 'tk',
        // token请在天地图官网申请
        tokenValue: getTDTToken(),
        // 图层透明度
        opacity: layerOpacity
      })
      // 添加图层
      map.add(TDTLayer)
      topLayer = TDTLayer
    }

    // 移地图
    function removeLayer(){
      if (topLayer) {
        map.remove(topLayer)
        [BDLayer,GDLayer,TDTLayer].forEach(layer => {
          if(layer === topLayer){
            layer = undefined
            topLayer = undefined
          }
        });
        
      }
    }

    // 显隐图层
    function toggleLayer(type) {
      if (type === 'BD' && BDLayer) {
        BDLayer.visible = !BDLayer.visible
      }
      if (type === 'GD' && GDLayer) {
        GDLayer.visible = !GDLayer.visible
      }
      if (type === 'TDT' && TDTLayer) {
        TDTLayer.visible = !TDTLayer.visible
      }
    }

    // 设置裁剪多边形
    function setClippingArea(){
      const clippingArea = getPolygonClip()
      if (BDLayer) {
        BDLayer.clippingArea = clippingArea
      }
      if (GDLayer) {
        GDLayer.clippingArea = clippingArea
      }
      if (TDTLayer) {
        TDTLayer.clippingArea = clippingArea
      }
    }

    
    function getPolygonClip() {
      return new Polygon({
        coordinates: [
          [
            [116.346578,39.946966],
            [116.512309,39.956366],
            [116.508530,39.867088],
            [116.291089,39.873072],
            [116.346578,39.946966]
          ]
        ]
      })
    }

    //初始化示例UI操作
    function initUI() {
      layui.use(function () {
        layui.slider.render({
          elem: '#moveStepBD',
          value: 100,
          min: 0,
          max: 100,
          step: 1,
          theme: 'rgb(21, 134, 238)',
          //自定义提示文本
          setTips: function (value) {
            layerOpacity = value / 100
            return value + '%'
          },
          change: function (value) {
            // 图层透明度控制
            if (BDLayer) {
              BDLayer.opacity = layerOpacity
            }
          }
        })
        
        layui.slider.render({
          elem: '#moveStepGD',
          value: 100,
          min: 0,
          max: 100,
          step: 1,
          theme: 'rgb(21, 134, 238)',
          //自定义提示文本
          setTips: function (value) {
            layerOpacity = value / 100
            return value + '%'
          },
          change: function (value) {
            // 图层透明度控制
            if (GDLayer) {
              GDLayer.opacity = layerOpacity
            }
          }
        })
        
        layui.slider.render({
          elem: '#moveStepTDT',
          value: 100,
          min: 0,
          max: 100,
          step: 1,
          theme: 'rgb(21, 134, 238)',
          //自定义提示文本
          setTips: function (value) {
            layerOpacity = value / 100
            return value + '%'
          },
          change: function (value) {
            // 图层透明度控制
            if (TDTLayer) {
              TDTLayer.opacity = layerOpacity
            }
          }
        })
      })
    }
  </script>
</head>

<body onload="init();">
  <!--  视图容器div  -->
  <div id="mapgis-viewer" style="position: absolute; width: 100%; height: 100%"></div>
  <!--  示例UI  -->
  <div class="layui-panel layui-panel-right tile-layer-panel">
    <form class="layui-form" action="">
      <div class="layui-form-item" style="margin-bottom: 10px">
        调整底图（百度地图）属性
        <!-- <button type="button" class="layui-btn" onclick="addBDUnbiasedLayer()" style="margin-left: 6px">
          叠加百度地图（无偏显示）
        </button> -->
        <button type="button" class="layui-btn" onclick="toggleLayer('BD')" style="margin-left: 6px">
          显隐
        </button>
        <div class="layui-form-item" style="width: 170px; margin-left: 10px; display: inline-flex;">
          <label class="layui-form-label" style="width: 60px"> 透明度</label>
          <div class="layui-input-block sample-slider" style="width: 100px">
            <div id="moveStepBD"></div>
          </div>
        </div>
      </div>
      <div class="layui-form-item" style="margin-bottom: 10px">
        <button type="button" class="layui-btn" onclick="addGDUnbiasedLayer()" style="margin-left: 6px">
          叠加高德地图（无偏显示）
        </button>
        <button type="button" class="layui-btn" onclick="toggleLayer('GD')" style="margin-left: 6px">
          显隐
        </button>
        <div class="layui-form-item" style="width: 170px; margin-left: 10px; display: inline-flex;">
          <label class="layui-form-label" style="width: 60px"> 透明度</label>
          <div class="layui-input-block sample-slider" style="width: 100px">
            <div id="moveStepGD"></div>
          </div>
        </div>
      </div>
      <div class="layui-form-item" style="margin-bottom: 10px">
        <button type="button" class="layui-btn" onclick="addTDTLayer()" style="margin-left: 6px">
          叠加天地图
        </button>
        <button type="button" class="layui-btn" onclick="toggleLayer('TDT')" style="margin-left: 6px">
          显隐
        </button>
        <div class="layui-form-item" style="width: 170px; margin-left: 10px; display: inline-flex;">
          <label class="layui-form-label" style="width: 60px"> 透明度</label>
          <div class="layui-input-block sample-slider" style="width: 100px">
            <div id="moveStepTDT"></div>
          </div>
        </div>
      </div>
      <div class="line"></div>
      <div class="layui-form-item">
        <button type="button" class="layui-btn" onclick="setClippingArea()" style="margin-left: 6px">
          设置裁剪区
        </button>
        <!-- <button type="button" class="layui-btn" onclick="removeLayer()" style="margin-left: 6px">
          移除最上层的图层（最后一个始终保留）
        </button> -->
      </div>
    </form>
  </div>
  <style>
    .layui-panel {
      width: auto;
    }

    .layui-btn-normal {
      margin-right: 1px !important;
      font-size: 15px;
      padding: 0px 7px;
    }
  </style>
</body>

</html>
