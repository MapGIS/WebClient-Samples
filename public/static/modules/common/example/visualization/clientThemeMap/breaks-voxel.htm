<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>栅格体元-分段</title>
    <script src="http://10.10.130.72:8086/static/libs/cdn/cesium/Cesium.js"></script>
    <!--plugin脚本库-->
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-common.min.js"></script>
    <script src="http://10.10.130.72:8086/static/libs/cdn/zondyclient/webclient-cesium-plugin.min.js"></script>
    <script src="http://10.10.130.72:8086/static/assets/js/TDT-token.js"></script>
    <!--cesium样式-->
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/cdn/cesium/Widgets/widgets.css"
    />

    <!--示例中面板、按钮等，第三方layui的js库与css样式-->
    <script src="http://10.10.130.72:8086/static/libs/cdn/layui/layui.js"></script>
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/cdn/layui/css/layui.css"
    />
    <!--示例公共样式-->
    <link
      rel="stylesheet"
      href="http://10.10.130.72:8086/static/libs/css/style.css"
    />
    <script>
      'use strict'
      // 定义三维视图的主要类
      let map
      let sceneView
      let viewer
      let layer
      let styleValue = 0 // 当前选中的渲染样式，0表示默认样式，1表示分段渲染样式

      // 添加M3D 2.1栅格体元数据
      function addM3D21ModelCacheLayer(needRender) {
        // 参考API: http://10.10.130.72:8086/static/modules/common/api/common-mapgis/M3DModelCacheLayer.html
        layer = new zondy.layer.M3DModelCacheLayer({
          // 服务基地址
          url: 'http://10.10.130.72:8089/igs/rest/services/M3Dv2/rhum2011/M3dServer',
          // renderer: needRender ? layerRenderer : undefined,
          clientFilters: [{ minValue: 0, maxValue: 101 }],
          elevationInfo: {
            featureExpressionInfo: {
              expression: '$feature.z * ' + 10
            }
          },
          // 初始化参数
          extensionOptions: {
            // 开启自动跳转
            autoReset: true
          }
        })
        map.add(layer)
      }

      // 切换renderer
      function changeRenderer(styleValue) {
        switch (styleValue) {
          case 0:
            // 切换到默认样式，即去除图层对象的renderer
            layer.renderer = null
            break
          case 1:
            layer.renderer = layerRenderer
            break
        }
      }

      // 初始化示例UI操作
      function initUI() {
        layui.use(function () {
          var form = layui.form
          form.on('select(styleValue)', function (data) {
            // 切换renderer
            styleValue = Number(data.value)
            changeRenderer(Number(data.value))
          })
        })
      }

      // 初始化三维球体
      function initViewer() {
        // 初始化图层管理容器
        map = new zondy.Map()
        // 初始化地图视图对象
        sceneView = new zondy.cesium.SceneView({
          // 视图id
          viewId: 'mapgis-3d-viewer',
          // 图层管理容器
          map: map
        })
        // 获取视图对象
        viewer = sceneView.getInnerView()
      }

      // 地图初始化函数
      function init() {
        // 初始化三维球体
        initViewer()
        // 默认添加M3D 2.1栅格体元数据
        addM3D21ModelCacheLayer()
        // 初始化示例UI操作
        initUI()
      }

      // 设置专题图渲染Renderer
      // 参考API: http://10.10.130.72:8086/static/modules/common/api/common-mapgis/ClassBreakRenderer.html
      const layerRenderer = new zondy.renderer.ClassBreakRenderer({
        // 专题图过滤字段名
        field: 'rhum',
        // 栅格体元数据中的默认配色，只有在单值和分段专题图下有效，拉伸渐变模式不生效
        defaultSymbol: new zondy.symbol.SimpleFillSymbol({
          // 填充颜色
          // 参考API: http://10.10.130.72:8086/static/modules/common/api/common-mapgis/Color.html
          color: new zondy.Color(0, 0, 255, 0.8)
        }),
        // 分段专题图过滤条件数组
        classBreakInfos: [
          {
            // 最小过滤范围，field对应的值大于等于minValue
            minValue: 0,
            // 最大过滤范围，field对应的值小于maxValue
            maxValue: 20,

            // 匹配到该值后的样式
            // M3D专题图仅支持SimpleFillSymbol符号
            // 参考API: http://10.10.130.72:8086/static/modules/common/api/common-mapgis/SimpleFillSymbol.html
            symbol: new zondy.symbol.SimpleFillSymbol({
              // 填充颜色
              // 参考API: http://10.10.130.72:8086/static/modules/common/api/common-mapgis/Color.html
              color: new zondy.Color(255, 0, 0, 0.8)
            })
          },
          {
            // 最小过滤范围，field对应的值大于等于minValue
            minValue: 20,
            // 最大过滤范围，field对应的值小于maxValue
            maxValue: 40,
            // 匹配到该值后的样式
            // M3D专题图仅支持SimpleFillSymbol符号
            // 参考API: http://10.10.130.72:8086/static/modules/common/api/common-mapgis/SimpleFillSymbol.html
            symbol: new zondy.symbol.SimpleFillSymbol({
              // 填充颜色
              // 参考API: http://10.10.130.72:8086/static/modules/common/api/common-mapgis/Color.html
              color: new zondy.Color(255, 255, 0, 0.8)
            })
          },
          {
            // 最小过滤范围，field对应的值大于等于minValue
            minValue: 40,
            // 最大过滤范围，field对应的值小于maxValue
            maxValue: 60,
            // 匹配到该值后的样式
            // M3D专题图仅支持SimpleFillSymbol符号
            // 参考API: http://10.10.130.72:8086/static/modules/common/api/common-mapgis/SimpleFillSymbol.html
            symbol: new zondy.symbol.SimpleFillSymbol({
              // 填充颜色
              // 参考API: http://10.10.130.72:8086/static/modules/common/api/common-mapgis/Color.html
              color: new zondy.Color(0, 255, 0, 0.8)
            })
          },
          {
            // 最小过滤范围，field对应的值大于等于minValue
            minValue: 60,
            // 最大过滤范围，field对应的值小于maxValue
            maxValue: 80,
            // 匹配到该值后的样式
            // M3D专题图仅支持SimpleFillSymbol符号
            symbol: new zondy.symbol.SimpleFillSymbol({
              // 填充颜色
              color: new zondy.Color(0, 255, 255, 0.8)
            })
          }
          // {
          //   // 最小过滤范围，field对应的值大于等于minValue
          //   minValue: 80,
          //   // 最大过滤范围，field对应的值小于maxValue
          //   maxValue: 100,
          //   // 匹配到该值后的样式
          //   // M3D专题图仅支持SimpleFillSymbol符号
          //   symbol: new zondy.symbol.SimpleFillSymbol({
          //     // 填充颜色
          //     color: new zondy.Color(255, 255, 255, 0.8)
          //   })
          // },
        ]
      })
    </script>
  </head>

  <body onload="init()">
    <div id="mapgis-3d-viewer"></div>
    <div class="layui-panel layui-panel-right">
      <form class="layui-form" action="">
        <div class="layui-form-item">
          <label class="layui-form-label">渲染样式</label>
          <div class="layui-input-block" style="width: 180px">
            <select
              name="styleValue"
              lay-verify="required"
              lay-filter="styleValue"
            >
              <option value="0" selected>默认样式</option>
              <option value="1">分段渲染样式</option>
            </select>
          </div>
        </div>
      </form>
    </div>
  </body>
</html>
